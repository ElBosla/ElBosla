<!DOCTYPE html>
<html class="light" dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ุชุณุฌูู ุฏุฎูู ุงููุดุชุฑููู - ุจูุตูุฉ</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13b6ec",
                        "secondary": "#263238",
                    },
                    fontFamily: { "sans": ["Almarai", "sans-serif"] },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Almarai', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
    <div class="max-w-md w-full glass p-8 rounded-[2.5rem] shadow-2xl border border-white">
        <div class="text-center mb-8">
            <img src="../assets/images/logo.jpg" alt="Logo" class="size-20 mx-auto rounded-3xl shadow-lg mb-4">
            <h1 class="text-2xl font-black text-secondary">ููุตุฉ ููุฑุณุงุช ุจูุตูุฉ</h1>
            <p id="formSubtitle" class="text-gray-400 font-bold mt-2 text-sm">ูู ุจุชุณุฌูู ุงูุฏุฎูู ูููุตูู ูููุญุชูู ุงูุฎุงุต ุจู
            </p>
        </div>

        <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-8">
            <button onclick="switchTab('login')" id="tab-login"
                class="flex-1 py-3 text-sm font-black rounded-xl transition-all bg-white shadow-sm text-secondary">ุชุณุฌูู
                ุงูุฏุฎูู</button>
            <button onclick="switchTab('signup')" id="tab-signup"
                class="flex-1 py-3 text-sm font-black rounded-xl transition-all text-gray-400">ุฅูุดุงุก ุญุณุงุจ</button>
        </div>

        <form id="coursePortalForm" class="space-y-4">
            <input type="hidden" id="formType" value="login">

            <div id="nameField" class="space-y-2 hidden">
                <label class="text-xs font-bold text-gray-400 mr-2">ุงูุงุณู ุจุงููุงูู</label>
                <input type="text" id="name" placeholder="ุฃุฏุฎู ุงุณูู ููุง ูู ูุณุฌู"
                    class="w-full h-12 bg-white border-2 border-gray-100 rounded-xl px-4 font-bold focus:border-primary outline-none transition-all">
            </div>

            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 mr-2">ุฑูู ุงููุงุชู</label>
                <input type="tel" id="phone" required placeholder="01xxxxxxxxx"
                    class="w-full h-12 bg-white border-2 border-gray-100 rounded-xl px-4 font-bold focus:border-primary outline-none transition-all text-center"
                    dir="ltr">
            </div>

            <div id="passwordField" class="space-y-2">
                <label id="passwordLabel" class="text-xs font-bold text-gray-400 mr-2">ูููุฉ ุงูุณุฑ</label>
                <input type="password" id="password" required placeholder="โขโขโขโขโขโขโขโข"
                    class="w-full h-12 bg-white border-2 border-gray-100 rounded-xl px-4 font-bold focus:border-primary outline-none transition-all text-center">
                <p id="signupNotice" class="text-[10px] text-orange-500 font-bold mt-1 text-center hidden">ุจุฑุฌุงุก ุงุฎุชูุงุฑ
                    ูููุฉ ุณุฑ ูููุฉ ูุญูุธูุง ุฌูุฏุงู ูุชุชููู ูู ุงูุฏุฎูู ูุงุญูุงู.</p>
            </div>

            <div id="coursesField" class="space-y-4 hidden">
                <label class="text-xs font-bold text-gray-400 mr-2">ุงุฎุชุงุฑ ุงูููุฑุณุงุช ุงูุชู ุชูุฏ ุงูุงุดุชุฑุงู ุจูุง</label>
                <div id="signupCoursesList"
                    class="space-y-3 max-h-60 overflow-y-auto p-3 bg-gray-50 rounded-xl border-2 border-gray-100">
                    <p class="text-[10px] text-gray-400 text-center py-2">ุฌุงุฑู ุชุญููู ุงูููุฑุณุงุช...</p>
                </div>

                <!-- Payment Proof Upload Section -->
                <div id="paymentSection" class="space-y-3 hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <h3 class="text-xs font-black text-blue-900 mb-3 flex items-center gap-2">
                            <span>๐ณ</span>
                            <span>ูุนูููุงุช ุงูุชุญููู</span>
                        </h3>

                        <!-- Transfer Numbers -->
                        <div class="bg-white rounded-lg p-3 mb-3">
                            <p class="text-[10px] font-bold text-gray-500 mb-2">ูู ุจุงูุชุญููู ุนูู ุฃุญุฏ ุงููุญุงูุธ :</p>
                            <div class="space-y-1.5">
                                <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                    <span class="text-xs font-black text-secondary" dir="ltr">01098453187</span>
                                    <button type="button" onclick="copyNumber('01098453187')"
                                        class="text-[10px] text-primary font-bold hover:underline">ูุณุฎ</button>
                                </div>
                                <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg">
                                    <span class="text-xs font-black text-secondary" dir="ltr">01210178529</span>
                                    <button type="button" onclick="copyNumber('01210178529')"
                                        class="text-[10px] text-primary font-bold hover:underline">ูุณุฎ</button>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="space-y-2 mb-3">
                            <label class="text-[10px] font-bold text-gray-600">ุทุฑููุฉ ุงูุชุญููู:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="paymentMethod" value="ูุญูุธุฉ" class="peer hidden">
                                    <div
                                        class="bg-white border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/5 rounded-lg px-3 py-2 text-center transition-all">
                                        <span class="text-xs font-bold text-secondary">ูุญูุธุฉ</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="paymentMethod" value="ุญุณุงุจ ุจููู / ุงูุณุชุง ุจุงู"
                                        class="peer hidden">
                                    <div
                                        class="bg-white border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/5 rounded-lg px-3 py-2 text-center transition-all">
                                        <span class="text-xs font-bold text-secondary">ุญุณุงุจ ุจููู / ุงูุณุชุง ุจุงู</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Upload Screenshot -->
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-600">ุงุฑูุน ุตูุฑุฉ ุฅุซุจุงุช ุงูุชุญููู:</label>
                            <div class="relative">
                                <input type="file" id="paymentProof" accept="image/*" class="hidden"
                                    onchange="handleFileSelect(event)">
                                <label for="paymentProof"
                                    class="flex flex-col items-center justify-center w-full h-24 bg-white border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-all">
                                    <div id="uploadPlaceholder" class="text-center">
                                        <svg class="w-8 h-8 mx-auto mb-1 text-gray-400" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                            </path>
                                        </svg>
                                        <p class="text-[10px] font-bold text-gray-500">ุงุถุบุท ูุฑูุน ุงูุตูุฑุฉ</p>
                                    </div>
                                    <div id="uploadPreview" class="hidden text-center">
                                        <img id="previewImage" class="max-h-20 mx-auto rounded" />
                                        <p class="text-[10px] font-bold text-green-600 mt-1">โ ุชู ุงุฎุชูุงุฑ ุงูุตูุฑุฉ</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn"
                class="w-full h-14 bg-primary hover:bg-primary/90 text-white font-black rounded-xl shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2 mt-4">
                <span id="btnText">ุฏุฎูู ููููุตุฉ</span>
                <span id="loading" class="material-symbols-outlined animate-spin hidden">sync</span>
            </button>
        </form>
    </div>

    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@16.1.0"></script>
    <script src="../assets/js/appwrite.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function switchTab(type) {
            document.getElementById('formType').value = type;
            const isLogin = type === 'login';

            // UI elements
            document.getElementById('nameField').classList.toggle('hidden', isLogin);
            // Show password field in both login and signup
            document.getElementById('passwordField').classList.remove('hidden');
            document.getElementById('passwordLabel').textContent = isLogin ? 'ูููุฉ ุงูุณุฑ' : 'ุงุฎุชุฑ ูููุฉ ุณุฑ ูุญุณุงุจู';
            document.getElementById('signupNotice').classList.toggle('hidden', isLogin);
            document.getElementById('formSubtitle').textContent = isLogin ? 'ูู ุจุชุณุฌูู ุงูุฏุฎูู ูููุตูู ูููุญุชูู ุงูุฎุงุต ุจู' : 'ูู ุจุฅูุดุงุก ุญุณุงุจู ูุงุฎุชูุงุฑ ูููุฉ ุณุฑ ุฎุงุตุฉ ุจู';
            document.getElementById('btnText').textContent = isLogin ? 'ุฏุฎูู ููููุตุฉ' : 'ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ';

            // Tab styling
            document.getElementById('tab-login').classList.toggle('bg-white', isLogin);
            document.getElementById('tab-login').classList.toggle('shadow-sm', isLogin);
            document.getElementById('tab-login').classList.toggle('text-secondary', isLogin);
            document.getElementById('tab-login').classList.toggle('text-gray-400', !isLogin);

            document.getElementById('tab-signup').classList.toggle('bg-white', !isLogin);
            document.getElementById('tab-signup').classList.toggle('shadow-sm', !isLogin);
            document.getElementById('tab-signup').classList.toggle('text-secondary', !isLogin);
            document.getElementById('tab-signup').classList.toggle('text-gray-400', isLogin);

            // Clear fields
            document.getElementById('password').required = true;
            document.getElementById('name').required = !isLogin;

            // Show/Hide courses and reset payment fields
            document.getElementById('coursesField').classList.toggle('hidden', isLogin);

            if (isLogin) {
                // Hide payment section and reset required fields
                document.getElementById('paymentSection').classList.add('hidden');
                document.getElementById('paymentProof').required = false;
                document.querySelectorAll('input[name="paymentMethod"]').forEach(el => el.required = false);

                // Uncheck all courses
                document.querySelectorAll('input[name="selectedCourses"]').forEach(el => el.checked = false);
            } else {
                loadSignupCourses();
            }
        }

        async function loadSignupCourses() {
            const container = document.getElementById('signupCoursesList');
            try {
                const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSES);
                if (response.documents.length === 0) {
                    container.innerHTML = '<p class="text-[10px] text-gray-400 text-center py-2">ูุง ุชูุฌุฏ ููุฑุณุงุช ูุชุงุญุฉ ุญุงููุงู</p>';
                    return;
                }
                container.innerHTML = response.documents.map(c => `
                    <label class="flex items-center justify-between gap-3 p-3 hover:bg-white rounded-lg cursor-pointer transition-colors border-2 border-transparent hover:border-primary/20 group">
                        <div class="flex items-center gap-3 flex-1">
                            <input type="checkbox" name="selectedCourses" value="${c.$id}" data-price="${c.price || '0'}" class="accent-primary size-4 course-checkbox" onchange="updatePaymentSection()">
                            <div class="flex-1">
                                <span class="text-xs font-bold text-secondary block">${c.title}</span>
                                <span class="text-[10px] text-gray-400">${c.description || ''}</span>
                            </div>
                        </div>
                        <div class="text-left">
                            <span class="text-sm font-black text-primary">${c.price || 'ูุฌุงูู'}</span>
                            ${c.oldPrice ? `<span class="text-[10px] text-gray-400 line-through block">${c.oldPrice}</span>` : ''}
                        </div>
                    </label>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p class="text-[10px] text-red-400 text-center py-2">ุฎุทุฃ ูู ุชุญููู ุงูููุฑุณุงุช</p>';
            }
        }

        function updatePaymentSection() {
            const selectedCourses = document.querySelectorAll('input[name="selectedCourses"]:checked');
            const paymentSection = document.getElementById('paymentSection');

            if (selectedCourses.length > 0) {
                paymentSection.classList.remove('hidden');
                // Make payment fields required
                document.querySelector('input[name="paymentMethod"]').required = true;
                document.getElementById('paymentProof').required = true;
            } else {
                paymentSection.classList.add('hidden');
                // Make payment fields optional
                const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
                paymentMethods.forEach(pm => pm.required = false);
                document.getElementById('paymentProof').required = false;
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    document.getElementById('uploadPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function copyNumber(number) {
            navigator.clipboard.writeText(number).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'ุชู ุงููุณุฎ',
                    text: 'ุชู ูุณุฎ ุงูุฑูู ุจูุฌุงุญ',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        document.getElementById('coursePortalForm').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('formType').value;
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;

            const btn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');

            btn.disabled = true;
            loading.classList.remove('hidden');

            try {
                if (type === 'signup') {
                    // Check if already exists
                    const existing = await databases.listDocuments(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, [
                        Query.equal('phone', phone)
                    ]);

                    if (existing.documents.length > 0) {
                        throw new Error('ูุฐุง ุงูุฑูู ูุณุฌู ุจุงููุนู. ููููู ุชุณุฌูู ุงูุฏุฎูู.');
                    }

                    const selectedCourses = Array.from(document.querySelectorAll('input[name="selectedCourses"]:checked')).map(el => el.value);

                    if (selectedCourses.length === 0) {
                        throw new Error('ูุฑุฌู ุงุฎุชูุงุฑ ููุฑุณ ูุงุญุฏ ุนูู ุงูุฃูู ูุฅูุดุงุก ุงูุญุณุงุจ');
                    }

                    // Get payment information
                    let paymentProofId = null;
                    let paymentMethod = null;

                    if (selectedCourses.length > 0) {
                        const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');
                        const paymentProofFile = document.getElementById('paymentProof').files[0];

                        if (!paymentMethodInput || !paymentProofFile) {
                            throw new Error('ูุฑุฌู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุชุญููู ูุฑูุน ุตูุฑุฉ ุฅุซุจุงุช ุงูุชุญููู');
                        }

                        paymentMethod = paymentMethodInput.value;

                        // Upload payment proof to Appwrite Storage
                        try {
                            const uploadResponse = await storage.createFile(
                                BUCKETS.COURSE_THUMBNAILS, // Using same bucket, you can create a separate bucket for payment proofs
                                ID.unique(),
                                paymentProofFile
                            );
                            paymentProofId = uploadResponse.$id;
                        } catch (uploadErr) {
                            console.error('Upload error:', uploadErr);
                            throw new Error('ูุดู ุฑูุน ุตูุฑุฉ ุฅุซุจุงุช ุงูุชุญููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
                        }
                    }

                    const subData = {
                        name: name,
                        phone: phone,
                        password: password,
                        deviceId: '',
                        paymentStatus: selectedCourses.length > 0 ? 'pending' : 'free',
                        courses: selectedCourses,
                        paymentMethod: paymentMethod || '',
                        paymentProofId: paymentProofId || ''
                    };

                    try {
                        const newSub = await databases.createDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, ID.unique(), subData);

                        // Auto-login after signup
                        sessionStorage.setItem('sub_auth', 'true');
                        sessionStorage.setItem('sub_data', JSON.stringify({ ...subData, $id: newSub.$id }));

                        await Swal.fire({
                            icon: 'success',
                            title: 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ',
                            text: 'ููููู ุงูุขู ุชุตูุญ ุงูููุตุฉ. ุณูุชู ูุชุญ ูุญุชูู ุงูููุฑุณุงุช ูุงููุงู ููุฑ ุชูุนูู ุงุดุชุฑุงูู ูู ูุจู ุงูุฅุฏุงุฑุฉ.',
                            confirmButtonText: 'ุงุจุฏุฃ ุงูุชุตูุญ'
                        });
                        window.location.href = 'courses.html';
                        return;
                    } catch (createErr) {
                        // Fallback if attribute naming varies
                        if (createErr.message.includes('paymentStatus') || createErr.message.includes('courses') || createErr.message.includes('paymentMethod') || createErr.message.includes('paymentProofId')) {
                            // Try without optional fields
                            const minimalData = {
                                name: name,
                                phone: phone,
                                password: password,
                                deviceId: ''
                            };
                            const fallbackSub = await databases.createDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, ID.unique(), minimalData);
                            sessionStorage.setItem('sub_auth', 'true');
                            sessionStorage.setItem('sub_data', JSON.stringify({ ...minimalData, $id: fallbackSub.$id }));

                            await Swal.fire({
                                icon: 'warning',
                                title: 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ',
                                text: 'ุชู ุฅูุดุงุก ุญุณุงุจู ูููู ูู ูุชู ุญูุธ ูุนูููุงุช ุงูุฏูุน. ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ.',
                                confirmButtonText: 'ุญุณูุงู'
                            });
                            window.location.href = 'courses.html';
                            return;
                        } else {
                            throw createErr;
                        }
                    }
                } else {
                    // Login Logic
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, [
                        Query.equal('phone', phone)
                    ]);

                    if (response.documents.length === 0) {
                        throw new Error('ุฑูู ุงููุงุชู ุบูุฑ ูุณุฌู ุฃู ุจุงูุชุธุงุฑ ุงูุชูุนูู');
                    }

                    const sub = response.documents[0];

                    if (!sub.password || sub.password === '') {
                        throw new Error('ุญุณุงุจู ููุฏ ุงููุฑุงุฌุนุฉ. ุณูุชู ุชุฒููุฏู ุจูููุฉ ุงูุณุฑ ููุฑ ุชูุนูู ุงูุญุณุงุจ.');
                    }

                    if (sub.password !== password) {
                        throw new Error('ูููุฉ ุงูุณุฑ ุบูุฑ ุตุญูุญุฉ');
                    }

                    // Device Enforcement
                    const currentDeviceId = localStorage.getItem('bousla_curr_device') || (Math.random().toString(36).substring(2) + Date.now().toString(36));
                    localStorage.setItem('bousla_curr_device', currentDeviceId);

                    if (sub.deviceId && sub.deviceId !== currentDeviceId) {
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.NOTIFICATIONS, ID.unique(), {
                            subscriberName: sub.name,
                            action: 'ูุญุงููุฉ ุชุณุฌูู ุฏุฎูู ูู ุฌูุงุฒ ุซุงูู',
                            details: `ูุญุงููุฉ ุฏุฎูู ุจุงูุฌูุงุฒ: ${currentDeviceId} ุจูููุง ุงูุฌูุงุฒ ุงููุณุฌู ูู: ${sub.deviceId}`
                        });
                        throw new Error('ูุฐุง ุงูุญุณุงุจ ูุณุฌู ุนูู ุฌูุงุฒ ุขุฎุฑ ุจุงููุนู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ.');
                    }

                    if (!sub.deviceId) {
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, sub.$id, {
                            deviceId: currentDeviceId
                        });
                    }

                    sessionStorage.setItem('sub_auth', 'true');
                    sessionStorage.setItem('sub_data', JSON.stringify(sub));

                    await Swal.fire({
                        icon: 'success',
                        title: 'ุฃููุงู ุจู ูุง ' + sub.name,
                        text: 'ุฌุงุฑู ูููู ูููุญุชูู ุงูุชุนูููู...',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    window.location.href = 'courses.html';
                }
            } catch (err) {
                console.error('Login/Signup error:', err);
                Swal.fire({
                    icon: 'error',
                    title: 'ุชูุจูู',
                    text: err.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.',
                    confirmButtonText: 'ุญุณูุงู'
                });

                // Ensure button is re-enabled
                btn.disabled = false;
                loading.classList.add('hidden');
            } finally {
                // Double-check button state
                setTimeout(() => {
                    btn.disabled = false;
                    loading.classList.add('hidden');
                }, 100);
            }
        };
    </script>
</body>

</html>