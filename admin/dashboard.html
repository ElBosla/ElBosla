<!DOCTYPE html>
<html class="light" dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØµÙ„Ø© - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&amp;family=Manrope:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link rel="icon" href="../assets/images/logo.jpg" type="image/jpeg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script>
        // Suppress Tailwind CDN production warning
        const originalWarn = console.warn;
        console.warn = function (...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                return; // Suppress Tailwind CDN warning
            }
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if (localStorage.getItem('color-theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
        }
    </script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13b6ec",
                        "primary-dark": "#0e8cb5",
                        "background-light": "#f6f8f8",
                        "background-dark": "#101d22",
                        "secondary": "#263238",
                    },
                    fontFamily: {
                        "display": ["Almarai", "sans-serif"],
                        "body": ["Almarai", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Almarai', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #13b6ec;
            border-radius: 10px;
        }

        /* Sidebar Styles */
        .sidebar {
            transition: all 0.3s ease;
        }

        .sidebar-item.active {
            background-color: #13b6ec1a;
            color: #13b6ec;
            border-inline-end: 4px solid #13b6ec;
        }

        .sidebar-item {
            border-inline-end: 4px solid transparent;
        }

        /* Section Visibility */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }


        /* Dark Mode Transitions */
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        .dark {
            color-scheme: dark;
        }

        .dark body {
            background-color: #0f171a;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #1a2428;
            border-color: #2d373c;
        }

        .dark .text-secondary {
            color: #f1f5f9;
        }

        .dark .text-gray-600 {
            color: #94a3b8;
        }

        .dark .bg-gray-50 {
            background-color: #151e22;
        }

        .dark .border-gray-100 {
            border-color: #2d373c;
        }

        .dark nav {
            background-color: rgba(26, 36, 40, 0.9);
            border-bottom-color: #2d373c;
        }

        .dark input,
        .dark select,
        .dark textarea {
            background-color: #151e22;
            border-color: #2d373c;
            color: white;
        }

        /* Platform Buttons */
        .platform-btn.active[data-platform="facebook"] {
            background: #1877f2 !important;
            color: white !important;
            border-color: #1877f2 !important;
        }

        .platform-btn.active[data-platform="instagram"] {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%) !important;
            color: white !important;
            border-color: transparent !important;
        }

        .platform-btn.active[data-platform="linkedin"] {
            background: #0077b5 !important;
            color: white !important;
            border-color: #0077b5 !important;
        }

        .platform-btn.active[data-platform="whatsapp"] {
            background: #25d366 !important;
            color: white !important;
            border-color: #25d366 !important;
        }

        .platform-btn.active i {
            color: white !important;
        }

        /* Calendar Task Dot */
        .task-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            display: inline-block;
        }

        .task-dot.done {
            background: #10b981;
        }

        .task-dot.pending {
            background: #f59e0b;
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 280px;
                height: 100vh;
                background: white;
                z-index: 100;
                flex-direction: column;
                border-left: 1px solid #eee;
                padding: 20px 0;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                z-index: 90;
                display: none;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .sidebar-item {
                flex: none;
                flex-direction: row;
                justify-content: flex-start;
                gap: 12px;
                border: none;
                border-left: 4px solid transparent;
                border-radius: 0 !important;
                padding: 14px 24px !important;
            }

            .sidebar-item.active {
                border-left: 4px solid #13b6ec;
                background: rgba(19, 182, 236, 0.05);
            }

            .sidebar-item span:last-child {
                font-size: 14px;
            }

            .main-content {
                padding-bottom: 20px;
                margin-right: 0 !important;
            }

            /* Responsive Table Card Layout */
            #table-container table,
            #table-container thead,
            #table-container tbody,
            #table-container th,
            #table-container td,
            #table-container tr {
                display: block;
            }

            #table-container thead {
                display: none;
            }

            #table-container tr {
                margin-bottom: 1.5rem;
                padding: 1.25rem;
                border-radius: 1.5rem;
                background: white;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            }

            .dark #table-container tr {
                background: #1a2428;
                border: 1px solid #2d373c;
            }

            #table-container td {
                padding: 0.75rem 0;
                border-bottom: 1px solid #f1f5f9;
                display: flex;
                justify-content: space-between;
                align-items: center;
                white-space: normal;
            }

            .dark #table-container td {
                border-bottom-color: #2d373c;
            }

            #table-container td:last-child {
                border-bottom: none;
                justify-content: center;
                gap: 0.5rem;
            }

            /* Add data labels for table cells */
            #table-container td::before {
                content: attr(data-label);
                font-weight: 800;
                color: #94a3b8;
                font-size: 10px;
                text-transform: uppercase;
                margin-left: 1rem;
            }

            /* Chat Mobile Optimization */
            @media (max-width: 1024px) {
                #section-messages .flex-col.lg\:flex-row {
                    height: calc(100dvh - 145px) !important;
                    /* Total viewport minus top nav and bottom sidebar */
                    gap: 0 !important;
                    margin: -1rem !important;
                    /* Counter act main-content padding if any */
                }

                .chat-sidebar-mobile {
                    position: fixed;
                    top: 0;
                    right: -100%;
                    bottom: 70px;
                    /* Above mobile bottom nav */
                    width: 280px;
                    z-index: 150;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    border-radius: 0 !important;
                    background: white;
                }

                .dark .chat-sidebar-mobile {
                    background: #1a2428;
                }

                .chat-sidebar-mobile.open {
                    right: 0;
                    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.2);
                }

                .chat-overlay {
                    display: none;
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.4);
                    backdrop-filter: blur(4px);
                    z-index: 140;
                }

                .chat-overlay.show {
                    display: block;
                }

                #activeChatHeader {
                    padding: 0.75rem 1rem !important;
                }

                #chatMessages {
                    padding: 1rem !important;
                }
            }
        }

        /* Hide body until auth check completes */
        body {
            visibility: hidden;
        }

        /* Unified Button Styles */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #13b6ec;
            color: white;
            font-weight: 900;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(19, 182, 236, 0.2);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-primary:hover {
            transform: scale(1.05);
            background-color: #0ea5d6;
        }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: rgba(19, 182, 236, 0.1);
            color: #13b6ec;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-secondary:hover {
            background-color: rgba(19, 182, 236, 0.2);
        }

        .btn-destructive {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #fee2e2;
            color: #ef4444;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-destructive:hover {
            background-color: #ef4444;
            color: white;
        }

        /* Icon Button Styles for Tables */
        .btn-icon {
            width: 2.25rem;
            height: 2.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .btn-icon-primary {
            background-color: rgba(19, 182, 236, 0.1);
            color: #13b6ec;
        }

        .btn-icon-primary:hover {
            background-color: #13b6ec;
            color: white;
            box-shadow: 0 5px 10px rgba(19, 182, 236, 0.2);
        }

        .btn-icon-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .btn-icon-success:hover {
            background-color: #10b981;
            color: white;
            box-shadow: 0 5px 10px rgba(16, 185, 129, 0.2);
        }

        .btn-icon-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-icon-danger:hover {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 5px 10px rgba(239, 68, 68, 0.2);
        }

        .btn-icon-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .btn-icon-warning:hover {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 5px 10px rgba(245, 158, 11, 0.2);
        }

        /* BouslaAlert Custom Popup Styles */
        #bouslaAlert {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
            opacity: 0;
            z-index: 2000;
            /* Increased */
        }

        #bouslaAlert.active {
            opacity: 1;
            pointer-events: auto;
        }

        #bouslaAlert .alert-content {
            transform: scale(0.9) translateY(40px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #bouslaAlert.active .alert-content {
            transform: scale(1) translateY(0);
            opacity: 1 !important;
        }

        .alert-loading-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script>
        // Immediate Auth Check
        if (sessionStorage.getItem('admin_auth') !== 'true') {
            window.location.replace('index.html');
        } else {
            document.documentElement.style.visibility = 'visible';
            window.addEventListener('DOMContentLoaded', () => {
                document.body.style.visibility = 'visible';
            });
        }
    </script>
</head>

<body class="bg-background-light text-secondary antialiased overflow-x-hidden min-h-screen">

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="flex flex-col lg:flex-row">
        <!-- Sidebar -->
        <aside
            class="sidebar lg:w-72 lg:h-screen lg:sticky lg:top-0 bg-white dark:bg-[#1a2428] border-l border-gray-100 dark:border-gray-800 flex flex-col z-[100] overflow-y-auto">
            <div class="flex lg:flex-none items-center justify-between mb-6 lg:mb-10 px-6 py-8">
                <div class="flex items-center gap-3">
                    <img src="../assets/images/logo.jpg" alt="Ù„ÙˆØ¬Ùˆ Ø¨ÙˆØµÙ„Ø©"
                        class="size-12 rounded-2xl object-cover shadow-lg" />
                    <div>
                        <span
                            class="text-2xl font-black tracking-tight text-secondary dark:text-white block leading-none">Ø¨ÙˆØµÙ„Ø©</span>
                        <span
                            class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1 block">DashBoard</span>
                    </div>
                </div>
                <button onclick="toggleSidebar()"
                    class="lg:hidden size-10 bg-gray-50 dark:bg-gray-900 rounded-xl flex items-center justify-center text-gray-400">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="flex flex-col gap-1 lg:gap-2 flex-1 px-4 lg:px-0">
                <button onclick="switchSection('applicants')" id="nav-applicants"
                    class="sidebar-item active flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full">
                    <span class="material-symbols-outlined text-2xl">groups</span>
                    <span>Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                </button>
                <button onclick="switchSection('interns')" id="nav-interns"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full">
                    <span class="material-symbols-outlined text-2xl">work_outline</span>
                    <span>Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</span>
                </button>
                <button onclick="switchSection('consultations')" id="nav-consultations"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only">
                    <span class="material-symbols-outlined text-2xl">event_available</span>
                    <span>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</span>
                </button>

                <button onclick="switchSection('messages')" id="nav-messages"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only">
                    <span class="material-symbols-outlined text-2xl">chat_bubble</span>
                    <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                </button>
                <button onclick="switchSection('teachers')" id="nav-teachers"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only">
                    <span class="material-symbols-outlined text-2xl">record_voice_over</span>
                    <span>Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</span>
                </button>
                <button onclick="switchSection('users')" id="nav-users"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only">
                    <span class="material-symbols-outlined text-2xl">shield_person</span>
                    <span>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                </button>
                <button onclick="switchSection('courses')" id="nav-courses"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only">
                    <span class="material-symbols-outlined text-2xl">movie_filter</span>
                    <span>ÙƒÙˆØ±Ø³Ø§Øª Ø¨ÙˆØµÙ„Ø©</span>
                </button>
                <button onclick="switchSection('subscribers')" id="nav-subscribers"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only">
                    <span class="material-symbols-outlined text-2xl">person_add</span>
                    <span>Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
                </button>
                <a href="../index.html" target="_blank"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full text-gray-500 hover:text-primary hover:bg-primary/5">
                    <span class="material-symbols-outlined text-2xl">public</span>
                    <span>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                </a>
                <button onclick="switchSection('notifications')" id="nav-notifications"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-base transition-all w-full admin-only relative">
                    <span class="material-symbols-outlined text-2xl">notifications_active</span>
                    <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                    <span id="notif-badge"
                        class="absolute left-6 top-1/2 -translate-y-1/2 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
            </div>

            <div class="flex flex-col gap-2 mt-auto p-6 border-t border-gray-50 dark:border-gray-800">
                <button id="darkModeToggleSidebar"
                    class="flex items-center gap-3 px-4 py-3.5 text-gray-500 hover:text-primary hover:bg-primary/5 rounded-xl font-bold transition-all">
                    <span class="material-symbols-outlined theme-icon">dark_mode</span>
                    <span>Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
                </button>
                <button onclick="logout()"
                    class="flex items-center gap-3 px-4 py-3.5 text-gray-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-xl font-bold transition-all">
                    <span class="material-symbols-outlined">logout</span>
                    <span>Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-1 min-h-screen bg-gray-50/50 dark:bg-gray-900/50 transition-all">
            <!-- Top Navbar (Mobile) -->
            <nav
                class="lg:hidden sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-800 flex justify-between items-center px-6 h-20 shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()"
                        class="size-10 bg-gray-50 dark:bg-gray-800 rounded-xl flex items-center justify-center text-secondary dark:text-white mr-2">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <img src="../assets/images/logo.jpg" alt="Ù„ÙˆØ¬Ùˆ Ø¨ÙˆØµÙ„Ø©" class="size-10 rounded-xl object-cover" />
                    <span class="text-xl font-black text-secondary dark:text-white">Ø¨ÙˆØµÙ„Ø©</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="logout()"
                        class="size-10 bg-gray-50 dark:bg-gray-800 rounded-xl flex items-center justify-center text-gray-400">
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>
            </nav>

            <div class="p-4 lg:p-10">

                <!-- SECTION: APPLICANTS -->
                <section id="section-applicants" class="admin-section active">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
                        <!-- Right Side: Title & Subtitle -->
                        <div class="order-2 lg:order-1 text-right">
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†</h1>
                            <p class="text-gray-400 font-bold flex items-center justify-end gap-2 text-sm">
                                <span>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ Ø§Ù„Ù…Ø³Ø§Ø±Ø§ØªØŒ ÙˆØ§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡Ù…</span>
                                <span class="bg-gray-200 dark:bg-gray-700 w-1.5 h-1.5 rounded-full"></span>
                                <span id="currentDate" class="text-primary font-black">12 ÙŠÙ†Ø§ÙŠØ± 2026</span>
                            </p>
                        </div>

                        <!-- Left Side: Action Buttons -->
                        <div class="order-1 lg:order-2 flex items-center gap-3">
                            <button id="deleteAllBtn" class="btn-destructive admin-only">
                                <span class="material-symbols-outlined">delete_sweep</span>
                                <span>Ø­Ø°Ù Ø§Ù„ÙƒÙ„</span>
                            </button>

                            <input type="file" id="importExcelInput" accept=".xlsx, .xls" class="hidden" />
                            <button onclick="document.getElementById('importExcelInput').click()" class="btn-primary">
                                <span class="material-symbols-outlined">upload_file</span>
                                <span>Ø±ÙØ¹ Ø´ÙŠØª</span>
                            </button>

                            <button id="exportBtn" class="btn-primary">
                                <span class="material-symbols-outlined">download</span>
                                <span>ØªØµØ¯ÙŠØ± Excel</span>
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <!-- Total Applicants -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†
                                </p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white" id="applicantCount">0
                                </h3>
                            </div>
                            <div
                                class="size-16 bg-blue-50 dark:bg-blue-900/20 rounded-[1.5rem] flex items-center justify-center text-blue-500">
                                <span class="material-symbols-outlined text-3xl">groups</span>
                            </div>
                        </div>

                        <!-- Active Students -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙŠÙ†</p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white" id="activeCountStats">0
                                </h3>
                            </div>
                            <div
                                class="size-16 bg-green-50 dark:bg-green-900/20 rounded-[1.5rem] flex items-center justify-center text-green-500">
                                <span class="material-symbols-outlined text-3xl">check_circle</span>
                            </div>
                        </div>

                        <!-- Expiring Soon -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white" id="expiringCountStats">0
                                </h3>
                            </div>
                            <div
                                class="size-16 bg-orange-50 dark:bg-orange-900/20 rounded-[1.5rem] flex items-center justify-center text-orange-500">
                                <span class="material-symbols-outlined text-3xl">notifications_active</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filters & Search Bar -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-4 lg:p-4 border border-gray-100 dark:border-gray-800 shadow-sm mb-8">
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <!-- Search (Right in RTL) -->
                            <div class="relative w-full lg:w-auto lg:flex-[1.5]">
                                <span
                                    class="material-symbols-outlined absolute right-5 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                                <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ..."
                                    class="w-full h-14 pr-12 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-sm transition-all focus:bg-white dark:focus:bg-[#1a2428]">
                            </div>

                            <!-- Filters Dropdowns -->
                            <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto flex-[2]">
                                <select id="specializationFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right"
                                    style="background-image: none;">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ®ØµØµØ§Øª ğŸ”½</option>
                                </select>
                                <select id="planFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right"
                                    style="background-image: none;">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª ğŸ”½</option>
                                </select>
                                <select id="paymentFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right"
                                    style="background-image: none;">
                                    <option value="">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ ğŸ”½</option>
                                    <option value="paid">ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…</option>
                                    <option value="unpaid">Ù„Ù… ÙŠØ¯ÙØ¹ âŒ</option>
                                </select>
                            </div>

                            <!-- Reset Button (Left in RTL) -->
                            <button id="resetSearchBtn" class="btn-secondary w-full lg:w-auto h-14 px-8">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
                            </button>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden p-1">
                        <div id="loading-data" class="p-24 text-center">
                            <div
                                class="inline-block size-14 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-6">
                            </div>
                            <p class="text-gray-400 font-black tracking-widest uppercase text-xs">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                            </p>
                        </div>
                        <div id="error-message" class="hidden p-8 bg-red-50 text-red-600 text-center font-bold"></div>
                        <div class="overflow-x-auto" id="table-container"></div>
                    </div>
                </section>

                <!-- SECTION: INTERNS -->
                <section id="section-interns" class="admin-section">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</h1>
                            <p class="text-gray-400 font-bold flex items-center gap-2">
                                <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</span>
                                <span class="bg-gray-200 dark:bg-gray-700 w-1.5 h-1.5 rounded-full"></span>
                                <span class="text-primary font-black" id="internsCountBadge">0 Ø·Ù„Ø¨</span>
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="exportInternsToExcel()" class="btn-primary">
                                <span class="material-symbols-outlined">download</span>
                                <span>ØªØµØ¯ÙŠØ± Excel</span>
                            </button>
                            <button onclick="document.getElementById('internsExcelInput').click()"
                                class="btn-secondary">
                                <span class="material-symbols-outlined">upload</span>
                                <span>Ø±ÙØ¹ Excel</span>
                            </button>
                            <input type="file" id="internsExcelInput" accept=".xlsx,.xls" class="hidden"
                                onchange="importInternsFromExcel(event)">
                            <button onclick="openTraineeModal()" class="btn-primary">
                                <span class="material-symbols-outlined">person_add</span>
                                <span>Ø¥Ø¶Ø§ÙØ© Ù…ØªØ¯Ø±Ø¨</span>
                            </button>
                            <button onclick="fetchInterns()" class="btn-secondary px-4">
                                <span class="material-symbols-outlined">refresh</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-4 lg:p-4 border border-gray-100 dark:border-gray-800 shadow-sm mb-8">
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <!-- Search -->
                            <div class="relative w-full lg:w-auto lg:flex-[1.5]">
                                <span
                                    class="material-symbols-outlined absolute right-5 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                                <input type="text" id="internSearchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..."
                                    class="w-full h-14 pr-12 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-sm transition-all focus:bg-white dark:focus:bg-[#1a2428]">
                            </div>

                            <!-- Filters -->
                            <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto flex-[2]">
                                <select id="internTrackFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right">
                                    <option value="">ÙƒÙ„ Ø§Ù„ØªØ®ØµØµØ§Øª ğŸ”½</option>
                                    <option value="Web Development">Web Development</option>
                                    <option value="Frontend Development">Frontend Development</option>
                                    <option value="Backend Development">Backend Development</option>
                                    <option value="Fullstack Development">Fullstack Development</option>
                                    <option value="Mobile App Development">Mobile App Development</option>
                                    <option value="UI/UX Design">UI/UX Design</option>
                                    <option value="Graphic Design">Graphic Design</option>
                                    <option value="Digital Marketing">Digital Marketing</option>
                                    <option value="Content Creation">Content Creation</option>
                                    <option value="Freelancing">Freelancing</option>
                                    <option value="Tech Skills">Tech Skills</option>
                                    <option value="Soft Skills">Soft Skills</option>
                                </select>
                                <select id="internPackageFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right">
                                    <option value="">ÙƒÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª ğŸ”½</option>
                                    <option value="Starter">Starter</option>
                                    <option value="Professional">Professional</option>
                                    <option value="Pro">Pro</option>
                                </select>
                                <select id="internStatusFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right">
                                    <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª ğŸ”½</option>
                                    <option value="Pending">Pending â³</option>
                                    <option value="Accepted">Accepted âœ…</option>
                                    <option value="Rejected">Rejected âŒ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden p-1">
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead
                                    class="bg-gray-50 dark:bg-gray-800/50 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                                    <tr>
                                        <th class="px-8 py-5">Ø§Ù„Ù…ØªØ¯Ø±Ø¨</th>
                                        <th class="px-8 py-5">Ø§Ù„ØªØ±Ø§Ùƒ / Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                                        <th class="px-8 py-5">Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
                                        <th class="px-8 py-5">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th class="px-8 py-5">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</th>
                                        <th class="px-8 py-5 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="internsTableBody"
                                    class="divide-y divide-gray-50 dark:divide-gray-800 font-bold text-sm text-secondary dark:text-gray-200">
                                    <tr>
                                        <td colspan="6" class="text-center py-10 opacity-50">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- SECTION: CONSULTATIONS -->
                <section id="section-consultations" class="admin-section">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª
                                Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h1>
                            <p class="text-gray-400 font-bold flex items-center gap-2">
                                <span>Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</span>
                                <span class="bg-gray-200 dark:bg-gray-700 w-1.5 h-1.5 rounded-full"></span>
                                <span
                                    class="consultation-count-badge bg-primary/10 text-primary px-3 py-1 rounded-lg text-xs font-black">0
                                    Ø·Ù„Ø¨</span>
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="file" id="importConsultationExcelInput" accept=".xlsx, .xls" class="hidden" />
                            <button onclick="document.getElementById('importConsultationExcelInput').click()"
                                class="btn-secondary">
                                <span class="material-symbols-outlined">upload</span>
                                <span>Ø±ÙØ¹ Ø´ÙŠØª</span>
                            </button>

                            <button id="exportConsultationsBtn" class="btn-primary">
                                <span class="material-symbols-outlined">download</span>
                                <span>ØªØµØ¯ÙŠØ± Excel</span>
                            </button>
                        </div>
                    </div>

                    <!-- Consultation Filters -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 border border-gray-100 dark:border-gray-800 shadow-sm mb-10">
                        <div class="relative flex-1">
                            <span
                                class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                            <input type="text" id="consultationSearchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©..."
                                class="w-full h-14 pr-12 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-medium transition-all">
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto custom-scrollbar" id="consultation-table-container">
                            <div class="p-20 text-center text-gray-400 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª...</div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: MESSAGES (CHAT) -->
                <section id="section-messages" class="admin-section">
                    <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-180px)] lg:h-[calc(100vh-180px)]">
                        <div id="chatOverlay" class="chat-overlay lg:hidden" onclick="toggleChatSidebar()"></div>
                        <!-- Chats List -->
                        <div id="chatSidebar"
                            class="lg:w-80 bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 flex flex-col overflow-hidden shadow-sm chat-sidebar-mobile">
                            <div class="p-6 border-b border-gray-50 dark:border-gray-800">
                                <h2 class="text-xl font-black text-secondary dark:text-white">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
                                <p class="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-widest">Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„
                                    Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                            </div>
                            <div id="chatList" class="flex-1 overflow-y-auto space-y-1 p-2">
                                <!-- Student list items injected here -->
                                <div class="text-center py-10 opacity-30">
                                    <span class="material-symbols-outlined text-4xl">forum</span>
                                    <p class="text-xs font-bold mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø´Ø·Ø©</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Box -->
                        <div
                            class="flex-1 bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 flex flex-col overflow-hidden shadow-sm relative">
                            <div id="activeChatHeader"
                                class="p-4 lg:p-6 border-b border-gray-50 dark:border-gray-800 flex items-center justify-between">
                                <div class="flex items-center gap-2 lg:gap-4">
                                    <!-- Mobile Toggle -->
                                    <button onclick="toggleChatSidebar()"
                                        class="lg:hidden size-10 flex items-center justify-center text-gray-400 hover:text-primary transition-colors">
                                        <span class="material-symbols-outlined text-2xl">menu_open</span>
                                    </button>
                                    <div
                                        class="size-10 bg-primary/10 text-primary rounded-xl lg:rounded-2xl flex items-center justify-center">
                                        <span class="material-symbols-outlined text-xl lg:text-2xl"
                                            id="activeChatIcon">person</span>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-xs lg:text-base text-secondary dark:text-white leading-tight"
                                            id="activeChatTitle">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨</h3>
                                        <p class="text-[8px] lg:text-[10px] font-bold text-primary"
                                            id="activeChatStatus">Ù…ØªØµÙ„</p>
                                    </div>
                                </div>
                                <div class="flex gap-1 lg:gap-2">
                                    <button onclick="startMeeting()" id="meetingBtn"
                                        class="hidden px-3 py-1.5 lg:px-4 lg:py-2 bg-primary/10 text-primary rounded-lg lg:rounded-xl font-black text-[9px] lg:text-xs hover:bg-primary hover:text-white transition-all flex items-center gap-1 lg:gap-2">
                                        <span class="material-symbols-outlined text-sm lg:text-lg">videocam</span>
                                        <span class="hidden sm:inline">Ø§Ø¬ØªÙ…Ø§Ø¹</span>
                                        <span class="sm:hidden">Ù„Ù‚Ø§Ø¡</span>
                                    </button>
                                </div>
                            </div>

                            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                                <!-- Messages injected here -->
                                <div class="h-full flex flex-col items-center justify-center text-center opacity-20">
                                    <span class="material-symbols-outlined text-6xl">chat</span>
                                    <p class="font-black mt-4">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø´Ø§Øª</p>
                                </div>
                            </div>

                            <div class="p-4 bg-gray-50 dark:bg-[#151e22] border-t border-gray-100 dark:border-gray-800">
                                <form id="chatForm" class="flex items-center gap-2">
                                    <button type="button" id="voiceBtn" class="btn-icon btn-icon-primary size-14">
                                        <span class="material-symbols-outlined">mic</span>
                                    </button>
                                    <button type="button" onclick="document.getElementById('fileInput').click()"
                                        class="btn-icon btn-icon-secondary size-14">
                                        <span class="material-symbols-outlined">attach_file</span>
                                    </button>
                                    <input type="file" id="fileInput" class="hidden" multiple
                                        onchange="handleFileUpload(this.files)">
                                    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                                        class="flex-1 h-14 bg-white dark:bg-gray-800 border-none rounded-2xl px-6 font-bold text-secondary dark:text-white focus:ring-2 focus:ring-primary shadow-sm">
                                    <button type="submit" class="btn-primary size-14 px-0">
                                        <span class="material-symbols-outlined">send</span>
                                    </button>
                                </form>
                                <div id="recordingStatus"
                                    class="hidden items-center justify-between bg-primary/10 p-4 rounded-2xl mt-2 animate-pulse">
                                    <div class="flex items-center gap-3">
                                        <span class="size-3 bg-red-500 rounded-full"></span>
                                        <span class="text-xs font-black text-primary">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... <span
                                                id="recordTimer">00:00</span></span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="cancelRecording()"
                                            class="text-red-500 font-bold text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                                        <button onclick="stopAndSendRecording()"
                                            class="bg-primary text-white px-4 py-2 rounded-xl text-xs font-black">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="section-teachers" class="admin-section admin-only">
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h1>
                            <p class="text-gray-400 font-bold">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙÙŠ Ø¨ÙˆØµÙ„Ø©</p>
                        </div>
                        <button onclick="openTeacherModal()" class="btn-primary">
                            <span class="material-symbols-outlined">person_add</span>
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="teachers-grid">
                        <!-- Teachers cards injected here -->
                    </div>
                </section>

                <!-- SECTION: USERS -->
                </section>

                </section>

                <section id="section-users" class="admin-section">
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
                            <p class="text-gray-400 font-bold">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªØ­Ø¯ÙŠØ¯ Ø£Ø¯ÙˆØ§Ø±Ù‡Ù…</p>
                        </div>
                        <button onclick="openUserModal()" class="btn-primary">
                            <span class="material-symbols-outlined">person_add</span>
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                        <table class="w-full text-right">
                            <thead
                                class="bg-gray-50 dark:bg-gray-800/50 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                                <tr>
                                    <th class="px-8 py-5">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th class="px-8 py-5">Ø§Ù„Ø¯ÙˆØ± / Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                                    <th class="px-8 py-5">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="px-8 py-5 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-gray-50 dark:divide-gray-800"></tbody>
                        </table>
                    </div>
                </section>

                <!-- SECTION: CONTENT (CALENDAR) -->



                <!-- Courses Section -->
                <section id="section-courses" class="admin-section">
                    <div class="flex items-center justify-between mb-10">
                        <div>
                            <h2 class="text-3xl font-black text-secondary">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h2>
                            <p class="text-gray-400 font-bold">Ø±ÙØ¹ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</p>
                        </div>
                        <button onclick="openCourseModal()" class="btn-primary flex items-center gap-2 px-6">
                            <span class="material-symbols-outlined">add_circle</span>
                            Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Courses list injected here -->
                    </div>
                </section>

                <!-- Subscribers Section -->
                <section id="section-subscribers" class="admin-section">
                    <div class="flex flex-col lg:flex-row items-center justify-between mb-10 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-secondary">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
                            <p class="text-gray-400 font-bold">Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="file" id="importSubscribersExcelInput" accept=".xlsx, .xls" class="hidden"
                                onchange="importSubscribersFromExcel(event)" />
                            <button onclick="document.getElementById('importSubscribersExcelInput').click()"
                                class="btn-secondary">
                                <span class="material-symbols-outlined">upload</span>
                                <span>Ø±ÙØ¹ Excel</span>
                            </button>
                            <button onclick="exportSubscribersToExcel()" class="btn-primary">
                                <span class="material-symbols-outlined">download</span>
                                <span>ØªØµØ¯ÙŠØ± Excel</span>
                            </button>
                            <button onclick="openSubscriberModal()" class="btn-primary flex items-center gap-2 px-6">
                                <span class="material-symbols-outlined">person_add</span>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                    </div>

                    <!-- Subscribers Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <!-- Total Subscribers -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
                                </p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white"
                                    id="totalSubscribersCount">0</h3>
                            </div>
                            <div
                                class="size-16 bg-blue-50 dark:bg-blue-900/20 rounded-[1.5rem] flex items-center justify-center text-blue-500">
                                <span class="material-symbols-outlined text-3xl">groups</span>
                            </div>
                        </div>

                        <!-- Paid Subscribers -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ù…Ø´ØªØ±Ùƒ Ø¯ÙØ¹</p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white"
                                    id="paidSubscribersCount">0</h3>
                            </div>
                            <div
                                class="size-16 bg-green-50 dark:bg-green-900/20 rounded-[1.5rem] flex items-center justify-center text-green-500">
                                <span class="material-symbols-outlined text-3xl">check_circle</span>
                            </div>
                        </div>

                        <!-- Unpaid Subscribers -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ù„Ù… ÙŠØ¯ÙØ¹</p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white"
                                    id="unpaidSubscribersCount">0</h3>
                            </div>
                            <div
                                class="size-16 bg-red-50 dark:bg-red-900/20 rounded-[1.5rem] flex items-center justify-center text-red-500">
                                <span class="material-symbols-outlined text-3xl">error</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-4 lg:p-4 border border-gray-100 dark:border-gray-800 shadow-sm mb-8">
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <!-- Search -->
                            <div class="relative w-full lg:w-auto lg:flex-[1.5]">
                                <span
                                    class="material-symbols-outlined absolute right-5 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                                <input type="text" id="subSearchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..."
                                    class="w-full h-14 pr-12 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-sm transition-all focus:bg-white dark:focus:bg-[#1a2428]">
                            </div>

                            <!-- Filters -->
                            <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto flex-[2]">
                                <select id="subStatusFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right">
                                    <option value="">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ (Ø§Ù„ÙƒÙ„) ğŸ”½</option>
                                    <option value="paid">ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…</option>
                                    <option value="pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ â³</option>
                                    <option value="unpaid">Ù„Ù… ÙŠØ¯ÙØ¹ âŒ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] shadow-sm overflow-hidden border border-gray-100 dark:border-gray-800">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 uppercase text-[10px] font-black text-gray-400">
                                <tr>
                                    <th class="px-8 py-5">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th class="px-8 py-5">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th class="px-8 py-5">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                    <th class="px-8 py-5">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</th>
                                    <th class="px-8 py-5 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="subscribersTableBody" class="divide-y divide-gray-50">
                                <!-- Subscribers list injected here -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Notifications Section -->
                <section id="section-notifications" class="admin-section">
                    <div class="mb-10">
                        <h2 class="text-3xl font-black text-secondary">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†</h2>
                        <p class="text-gray-400 font-bold">Ø±ØµØ¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ ÙˆÙ…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</p>
                    </div>

                    <div id="notifications-list" class="space-y-4">
                        <!-- Notifications injected here -->
                    </div>
                </section>
            </div>
        </main>

        <!-- Modal Backdrop -->
        <div id="applicantModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6 sm:px-0">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

            <div
                class="relative mx-auto mt-10 max-w-4xl bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-6 lg:p-10 shadow-2xl transform transition-all overflow-hidden border border-white/20">
                <div
                    class="absolute top-0 right-0 w-48 h-48 bg-primary/5 rounded-bl-full -mr-24 -mt-24 pointer-events-none">
                </div>

                <div class="flex justify-between items-start mb-8 relative">
                    <div class="flex items-center gap-4">
                        <div class="size-16 bg-primary/10 rounded-3xl flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-4xl">account_circle</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-secondary">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
                            <p class="text-gray-400 text-sm font-bold">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                        </div>
                    </div>
                    <button onclick="closeModal()"
                        class="size-10 bg-gray-100 hover:bg-gray-200 rounded-2xl flex items-center justify-center text-gray-500 transition-all">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div id="applicantDetails" class="space-y-6 relative">
                    <!-- Details injected here -->
                </div>

                <div class="mt-10 pt-8 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3">
                    <button onclick="closeModal()" class="btn-secondary px-8">Ø¥ØºÙ„Ø§Ù‚</button>
                    <div id="modalActionContainer"></div>
                </div>
            </div>
        </div>

        <!-- CONTENT MODAL -->

        <!-- Teacher Modal -->
        <div id="teacherModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeTeacherModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-2xl bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 lg:p-10 shadow-2xl transition-all border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6" id="teacherModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³
                    Ø¬Ø¯ÙŠØ¯</h2>
                <form id="teacherForm" class="space-y-6">
                    <input type="hidden" id="teacherId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³</label>
                            <input type="text" id="teacherName" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„ØªØ®ØµØµ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                            <input type="text" id="teacherSubject" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="teacherPhone"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="url" id="teacherImage"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white"
                                placeholder="https://...">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¯Ø®ÙˆÙ„)</label>
                            <input type="text" id="teacherUsername" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="text" id="teacherPassword" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white"
                                placeholder="Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ± (Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ù†Ø¨Ø°Ø© ØªØ¹Ø±ÙŠÙÙŠØ©</label>
                        <textarea id="teacherBio" rows="4"
                            class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-2xl p-4 font-bold text-secondary dark:text-white"></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeTeacherModal()" class="btn-secondary px-8">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary px-8">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- User Modal -->
        <div id="userModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeUserModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <form id="userForm" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input type="text" id="username" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="userPassword" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                        <select id="userRole"
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="teacher">Ù…Ø¯Ø±Ø³ (ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø©)</option>
                            <option value="admin">Ù…Ø³Ø¤ÙˆÙ„ ÙƒØ§Ù…Ù„ (Admin)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary w-full py-4 mt-4">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                </form>
            </div>
        </div>
        <!-- Convert Modal -->
        <div id="convertModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeConvertModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <div class="flex items-center gap-4 mb-8">
                    <div class="size-12 bg-primary/10 rounded-2xl flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined">upgrade</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-secondary dark:text-white">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ù…Ø´ØªØ±Ùƒ</h2>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ§Ù„Ù…Ø¬Ø§Ù„
                        </p>
                    </div>
                </div>

                <form id="convertForm" class="space-y-6">
                    <input type="hidden" id="convertApplicantId">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                        <p id="convertApplicantName" class="font-black text-secondary dark:text-white"></p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„Ù…Ø¬Ø§Ù„ / Ø§Ù„ØªØ®ØµØµ</label>
                        <select id="convertSpecialization" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="Web Development">Web Development</option>
                            <option value="Frontend Development">Frontend Development</option>
                            <option value="Backend Development">Backend Development</option>
                            <option value="Fullstack Development">Fullstack Development</option>
                            <option value="Mobile App Development">Mobile App Development</option>
                            <option value="UX/UI Design">UX/UI Design</option>
                            <option value="Graphic Design">Graphic Design</option>
                            <option value="Digital Marketing">Digital Marketing</option>
                            <option value="Content Creation">Content Creation</option>
                            <option value="Freelancing">Freelancing</option>
                            <option value="Tech Skills">Tech Skills</option>
                            <option value="Soft Skills">Soft Skills</option>
                            <option value="Microsoft Office">Microsoft Office</option>
                            <option value="Cybersecurity">Cybersecurity</option>
                            <option value="Social Media Design">Social Media Design</option>
                            <option value="SEO">SEO</option>
                            <option value="Data Analytics">Data Analytics</option>
                            <option value="Media Buying">Media Buying</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø¨Ø§Ù‚Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                        <select id="convertPlan" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (50 Ø¬.Ù…)">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (50 Ø¬.Ù…)</option>
                            <option value="Ù…Ø­ØªØ±Ù (150 Ø¬.Ù…)">Ù…Ø­ØªØ±Ù (150 Ø¬.Ù…)</option>
                            <option value="Ù…Ù†ØªÙˆØ± (500 Ø¬.Ù…)">Ù…Ù†ØªÙˆØ± (500 Ø¬.Ù…)</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeConvertModal()"
                            class="btn-secondary flex-1 py-4">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary flex-1 py-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Intern Conversion Modal -->
        <div id="internConversionModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeInternConversionModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <div class="flex items-center gap-4 mb-8">
                    <div class="size-12 bg-primary/10 rounded-2xl flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined">model_training</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-secondary dark:text-white">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØªØ¯Ø±Ø¨ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</h2>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Ø§Ø®ØªÙŠØ§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                        </p>
                    </div>
                </div>

                <form id="internConversionForm" class="space-y-6">
                    <input type="hidden" id="icApplicantId">
                    <input type="hidden" id="icSourceCollection">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</label>
                        <p id="icApplicantName" class="font-black text-secondary dark:text-white"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„ØªØ±Ø§Ùƒ</label>
                            <select id="icTrack" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                                <option value="Web Development">Web Development</option>
                                <option value="Frontend Development">Frontend Development</option>
                                <option value="Backend Development">Backend Development</option>
                                <option value="Fullstack Development">Fullstack Development</option>
                                <option value="Mobile App Development">Mobile App Development</option>
                                <option value="UI/UX Design">UI/UX Design</option>
                                <option value="Graphic Design">Graphic Design</option>
                                <option value="Digital Marketing">Digital Marketing</option>
                                <option value="Content Creation">Content Creation</option>
                                <option value="Freelancing">Freelancing</option>
                                <option value="Tech Skills">Tech Skills</option>
                                <option value="Soft Skills">Soft Skills</option>
                                <option value="Microsoft Office">Microsoft Office</option>
                                <option value="Cybersecurity">Cybersecurity</option>
                                <option value="Social Media Design">Social Media Design</option>
                                <option value="SEO">SEO</option>
                                <option value="Data Analytics">Data Analytics</option>
                                <option value="Media Buying">Media Buying</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                            <select id="icLevel" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø¨Ø§Ù‚Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨</label>
                        <select id="icPackage" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="Starter">Starter</option>
                            <option value="Professional">Professional</option>
                            <option value="Pro">Pro</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeInternConversionModal()"
                            class="btn-secondary flex-1 py-4">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary flex-1 py-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Trainee Manual Add Modal -->
        <div id="traineeModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeTraineeModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6">Ø¥Ø¶Ø§ÙØ© Ù…ØªØ¯Ø±Ø¨ ÙŠØ¯ÙˆÙŠØ§Ù‹</h2>
                <form id="manualTraineeForm" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="mFullName" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="mEmail" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="mMobile"
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„ØªØ±Ø§Ùƒ</label>
                            <select id="mTrack" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                                <option value="Web Development">Web Development</option>
                                <option value="Frontend Development">Frontend Development</option>
                                <option value="Backend Development">Backend Development</option>
                                <option value="Fullstack Development">Fullstack Development</option>
                                <option value="Mobile App Development">Mobile App Development</option>
                                <option value="UI/UX Design">UI/UX Design</option>
                                <option value="Graphic Design">Graphic Design</option>
                                <option value="Digital Marketing">Digital Marketing</option>
                                <option value="Content Creation">Content Creation</option>
                                <option value="Freelancing">Freelancing</option>
                                <option value="Tech Skills">Tech Skills</option>
                                <option value="Soft Skills">Soft Skills</option>
                                <option value="Microsoft Office">Microsoft Office</option>
                                <option value="Cybersecurity">Cybersecurity</option>
                                <option value="Social Media Design">Social Media Design</option>
                                <option value="SEO">SEO</option>
                                <option value="Data Analytics">Data Analytics</option>
                                <option value="Media Buying">Media Buying</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
                            <select id="mPackage" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                                <option value="Starter">Starter</option>
                                <option value="Professional">Professional</option>
                                <option value="Pro">Pro</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                            <select id="mLevel" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="mStatus" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                                <option value="Pending">Pending</option>
                                <option value="Accepted">Accepted</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeTraineeModal()"
                            class="btn-secondary flex-1 py-4">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary flex-1 py-4">Ø­ÙØ¸ Ø§Ù„Ù…ØªØ¯Ø±Ø¨</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Course Modal -->
        <div id="courseModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeCourseModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯</h2>
                <form id="courseForm" class="space-y-4">
                    <input type="hidden" id="courseId">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³</label>
                        <input type="text" id="courseTitle" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³</label>
                        <textarea id="courseDescription" rows="3"
                            class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-xl p-4 font-bold"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</label>
                            <input type="text" id="courseOldPrice" placeholder="Ù…Ø«Ù„Ø§Ù‹: 500 Ø¬.Ù…"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</label>
                            <input type="text" id="coursePrice" placeholder="Ù…Ø«Ù„Ø§Ù‹: 250 Ø¬.Ù…"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ±Ø³</label>
                        <select id="courseIsFree"
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                            <option value="false">Ù…Ø¯ÙÙˆØ¹ (ÙŠØªØ·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ)</option>
                            <option value="true">Ù…Ø¬Ø§Ù†ÙŠ (Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù (Thumbnail)</label>
                        <input type="file" id="courseThumbnail" accept="image/*" class="w-full">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeCourseModal()"
                            class="btn-secondary flex-1 py-4">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary flex-1 py-4">Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ±Ø³</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Video Modal -->
        <div id="videoModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeVideoModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6" id="videoModalTitle">Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ
                    Ù„Ù„ÙƒÙˆØ±Ø³</h2>
                <form id="videoForm" class="space-y-4">
                    <input type="hidden" id="v_courseId">
                    <input type="hidden" id="v_videoId">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                        <input type="text" id="videoTitle" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                        <input type="file" id="videoFile" accept="video/*" class="w-full">
                        <p class="text-[10px] text-gray-400 font-bold">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø±ÙØ¹Ù‡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Appwrite
                            (Ø¹Ø§Ø¯Ø© 50MB Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŒ ÙŠÙØ¶Ù„ Ø¶ØºØ· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)</p>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeVideoModal()"
                            class="btn-secondary flex-1 py-4">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary flex-1 py-4 flex items-center justify-center gap-2">
                            <span id="video-upload-spinner"
                                class="material-symbols-outlined hidden animate-spin">sync</span>
                            <span id="video-upload-text">Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
                        </button>
                    </div>
                    <div id="video-progress-container" class="hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                            <div id="video-progress-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="video-progress-percent" class="text-center text-[10px] font-black mt-1">0%</p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Course Videos List Modal -->
        <div id="courseVideosModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeCourseVideosModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-2xl bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-black text-secondary dark:text-white" id="cvm-title">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³
                        </h2>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³</p>
                    </div>
                    <button onclick="openVideoModal(currentViewingCourseId)" class="btn-primary px-6 py-2">
                        Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ
                    </button>
                </div>

                <div id="videos-list-container" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    <!-- Videos will be loaded here -->
                </div>

                <div class="mt-8 border-t border-gray-100 pt-6 flex justify-end">
                    <button onclick="closeCourseVideosModal()" class="btn-secondary px-8">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>

        <!-- Subscriber Modal -->
        <div id="subscriberModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeSubscriberModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6" id="subModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
                </h2>
                <form id="subscriberForm" class="space-y-4">
                    <input type="hidden" id="subId">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="subName" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="subPhone" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold"
                            dir="ltr">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                            <input type="text" id="subPassword"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select id="subPaymentStatus"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold">
                                <option value="pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹</option>
                                <option value="paid">ØªÙ… Ø§Ù„Ø¯ÙØ¹</option>
                                <option value="blocked">Ù…Ø­Ø¸ÙˆØ±</option>
                            </select>
                        </div>
                    </div>

                    <div id="deviceResetContainer"
                        class="hidden p-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-900/30 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-[10px] font-black text-orange-600 mb-1">Ù‚ÙÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² (Device ID)</p>
                                <p id="deviceIdValue"
                                    class="text-xs font-bold text-secondary dark:text-white truncate max-w-[200px]"></p>
                            </div>
                            <button type="button" onclick="resetSubscriberDevice()"
                                class="px-3 py-1.5 bg-orange-500 text-white text-[10px] font-black rounded-lg hover:bg-orange-600 transition-colors">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²
                            </button>
                        </div>
                    </div>

                    <!-- Payment Information Section -->
                    <div id="paymentInfoContainer"
                        class="hidden space-y-3 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 rounded-2xl">
                        <h3 class="text-xs font-black text-blue-900 dark:text-blue-300 flex items-center gap-2">
                            <span>ğŸ’³</span>
                            <span>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹</span>
                        </h3>

                        <!-- Payment Method -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                            <p class="text-[10px] font-bold text-gray-500 mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„:</p>
                            <p id="paymentMethodValue" class="text-xs font-black text-secondary dark:text-white">-</p>
                        </div>

                        <!-- Payment Proof Screenshot -->
                        <div id="paymentProofContainer" class="bg-white dark:bg-gray-800 rounded-lg p-3 relative">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-[10px] font-bold text-gray-500">ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„:</p>
                                <button type="button" onclick="deleteSubscriberPaymentProof()"
                                    class="text-[10px] text-red-500 font-bold hover:underline flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">delete</span>
                                    Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©
                                </button>
                            </div>
                            <div class="relative group">
                                <img id="paymentProofImage" src="" alt="Payment Proof"
                                    class="w-full rounded-lg border-2 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary transition-all"
                                    onclick="viewPaymentProofFullscreen(this.src)">
                                <div
                                    class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
                                </div>
                            </div>
                            <input type="hidden" id="currentPaymentProofId">
                        </div>

                        <p class="text-[9px] text-gray-400 italic">* ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ "ØªÙ… Ø§Ù„Ø¯ÙØ¹" Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†
                            Ø§Ù„ØµÙˆØ±Ø©</p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 mr-2">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù‡Ø§</label>
                        <div id="adminSubCoursesList"
                            class="space-y-2 max-h-40 overflow-y-auto p-3 bg-gray-50 dark:bg-gray-800 rounded-xl border-none text-right">
                            <p class="text-[10px] text-gray-400 text-center py-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª...</p>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeSubscriberModal()"
                            class="btn-secondary flex-1 py-4">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary flex-1 py-4">Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Appwrite SDK -->
        <script src="https://cdn.jsdelivr.net/npm/appwrite@16.1.0"></script>
        <script src="../assets/js/appwrite.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

        <script>
            // --- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (Authentication) ---
            const userRole = sessionStorage.getItem('user_role') || 'teacher';
            const adminAuth = sessionStorage.getItem('admin_auth');

            if (adminAuth !== 'true') {
                window.location.href = 'index.html';
            }

            // Role-based visibility
            if (userRole === 'teacher') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                // If they try to access restricted sections via URL (if we had routing), we'd block it here.
            }

            function logout() {
                sessionStorage.removeItem('admin_auth');
                sessionStorage.removeItem('user_role');
                window.location.href = 'index.html';
            }

            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.toggle('sidebar-open');
                overlay.classList.toggle('active');
            }

            function switchSection(sectionId) {
                // If sidebar is open (on mobile), close it when a section is selected
                if (window.innerWidth <= 1024) {
                    const sidebar = document.querySelector('.sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    if (sidebar.classList.contains('sidebar-open')) {
                        sidebar.classList.remove('sidebar-open');
                        overlay.classList.remove('active');
                    }
                }
                // Role-based section restriction
                if (userRole === 'teacher' && (sectionId === 'users' || sectionId === 'finance' || sectionId === 'applicants' || sectionId === 'teachers' || sectionId === 'stats')) {
                    alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…');
                    return;
                }

                // Hide all sections
                document.querySelectorAll('.admin-section').forEach(sec => sec.classList.remove('active'));
                // Show selected section
                const targetSection = document.getElementById(`section-${sectionId}`);
                if (targetSection) targetSection.classList.add('active');

                // Update sidebar active state
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                const targetNav = document.getElementById(`nav-${sectionId}`);
                if (targetNav) targetNav.classList.add('active');

                // Fetch data for the section if needed
                if (sectionId === 'teachers' && userRole === 'admin') fetchTeachers();
                if (sectionId === 'users') fetchUsers();
                if (sectionId === 'messages') updateChatList();
                if (sectionId === 'stats') fetchVisitStats();
                if (sectionId === 'content') initCalendar();
                if (sectionId === 'consultations') renderConsultations();
                if (sectionId === 'interns') fetchInterns();
                if (sectionId === 'courses') fetchCourses();
                if (sectionId === 'subscribers') fetchSubscribers();
                if (sectionId === 'notifications') fetchAdminNotifications();
            }


            // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (client, databases, etc.) Ù…ØªØ§Ø­Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ù† appwrite-config.js
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙÙ‡Ø§ Ù‡Ù†Ø§

            function formatWhatsAppPhone(phone) {
                if (!phone) return "";
                let cleanPhone = phone.toString().replace(/\D/g, '');
                if (cleanPhone.startsWith('0')) {
                    return '2' + cleanPhone;
                }
                return cleanPhone;
            }

            const tableContainer = document.getElementById('table-container');
            const applicantCount = document.getElementById('applicantCount');
            const loadingData = document.getElementById('loading-data');
            const errorMessage = document.getElementById('error-message');
            const searchInput = document.getElementById('searchInput');
            const specializationFilter = document.getElementById('specializationFilter');
            const currentDateEl = document.getElementById('currentDate');

            // Set Current Date - Safe check
            if (currentDateEl) {
                currentDateEl.textContent = new Date().toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            let applicants = [];

            function populateFilters() {
                // Get unique values excluding 'Free Consultation'
                const regularApps = applicants.filter(a => a.plan !== 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const specs = [...new Set(regularApps.map(a => a.specialization).filter(Boolean))];
                const plans = [...new Set(regularApps.map(a => a.plan).filter(Boolean))];

                const specSelect = document.getElementById('specializationFilter');
                const planSelect = document.getElementById('planFilter');

                // Preserve the first option (All) and append new
                /*
                // Static population is already done in initFilters, but we can enhance it dynamically if needed.
                // For now, let's stick to update logic logic if we want dynamic only.
                // But the user requested design match, static might be safer for "All Specializations".
                // Let's just ensure listeners are attached.
                */
                // Re-attach listeners just in case
                specSelect.onchange = filter; // Use filter() instead of processApplicants
                planSelect.onchange = filter;
            }

            async function fetchApplicants() {
                loadingData.style.display = 'block';
                tableContainer.style.display = 'none';
                if (errorMessage) errorMessage.classList.add('hidden');

                try {
                    let queries = [Query.orderDesc('timestamp')];
                    if (sessionStorage.getItem('user_role') === 'teacher') {
                        const uid = sessionStorage.getItem('user_id');
                        if (uid) queries.push(Query.equal('teacherId', uid));
                    }

                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.APPLICANTS, queries);
                    applicants = response.documents.map(doc => ({ id: doc.$id, ...doc }));

                    if (sessionStorage.getItem('user_role') === 'admin') {
                        await fetchTeachers();
                    }

                    // Attach Listeners
                    document.getElementById('specializationFilter').onchange = filter;
                    document.getElementById('planFilter').onchange = filter;
                    document.getElementById('paymentFilter').onchange = filter;
                    document.getElementById('resetSearchBtn').onclick = () => {
                        searchInput.value = '';
                        document.getElementById('specializationFilter').value = '';
                        document.getElementById('planFilter').value = '';
                        document.getElementById('paymentFilter').value = '';
                        filter();
                    };

                    processApplicants();

                    client.subscribe(`databases.${DATABASE_ID}.collections.${COLLECTIONS.APPLICANTS}.documents`, response => {
                        if (response.events.some(e => e.includes('.create') || e.includes('.update') || e.includes('.delete'))) {
                            fetchApplicants();
                        }
                    });
                } catch (err) {
                    errorMessage.classList.remove('hidden');
                    errorMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + err.message;
                } finally {
                    loadingData.style.display = 'none';
                    tableContainer.style.display = 'block';
                }
            }

            function processApplicants() {
                // Update Stats for Applicants
                const activeApps = applicants.filter(a => a.status === 'Ù†Ø´Ø·');
                const statsEl = document.getElementById('activeCountStats');
                if (statsEl) statsEl.textContent = activeApps.length;

                // Expiring logic
                const now = new Date();
                const expiringApps = applicants.filter(a => {
                    if (!a.timestamp) return false;
                    const days = getSubscriptionDays(a.plan);
                    const expiry = new Date(new Date(a.timestamp).getTime() + (days * 24 * 60 * 60 * 1000));
                    const diff = expiry - now;
                    return diff > 0 && diff < (5 * 24 * 60 * 60 * 1000);
                });
                const expiringStatsEl = document.getElementById('expiringCountStats');
                if (expiringStatsEl) expiringStatsEl.textContent = expiringApps.length;

                // Update consultation counts
                const consultationApps = applicants.filter(a => a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const badge = document.querySelector('.consultation-count-badge');
                if (badge) badge.textContent = `${consultationApps.length} Ø·Ù„Ø¨`;

                filter();
                if (typeof updateChatList === 'function') updateChatList();
            }

            // --- Helper Function: Get Subscription Days ---
            function getSubscriptionDays(plan) {
                if (!plan) return 30; // Default to 30 days
                // Check if plan includes 3-month offer
                if (plan.includes('3 Ø´Ù‡ÙˆØ±') || plan.includes('Ø¹Ø±Ø¶ 3 Ø´Ù‡ÙˆØ±')) {
                    return 90; // 3 months = 90 days
                }
                return 30; // Default monthly subscription
            }

            // --- Dynamic Filter Population ---
            function initFilters() {
                // Static paths based on the website form
                const paths = ['Web Development', 'Digital Marketing', 'Content Creation', 'Freelancing', 'Tech Skills', 'Soft Skills', 'Microsoft Office'];
                specializationFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ®ØµØµØ§Øª</option>' +
                    paths.map(p => `<option value="${p}">${p}</option>`).join('');

                // Static plans based on the website form - Updated with new prices
                const plans = [
                    'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (100 Ø¬.Ù…)',
                    'Ø¹Ø±Ø¶ 3 Ø´Ù‡ÙˆØ± - Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (250 Ø¬.Ù…)',
                    'Ù…Ø­ØªØ±Ù (200 Ø¬.Ù…)',
                    'Ø¹Ø±Ø¶ 3 Ø´Ù‡ÙˆØ± - Ù…Ø­ØªØ±Ù (500 Ø¬.Ù…)',
                    'Ù…Ù†ØªÙˆØ± (500 Ø¬.Ù…)'
                ];
                const planSelect = document.getElementById('planFilter');
                planSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</option>' +
                    plans.map(p => `<option value="${p}">${p}</option>`).join('');
            }
            initFilters();

            // --- Teachers Management ---
            function openTeacherModal(teacher = null) {
                document.getElementById('teacherModal').classList.remove('hidden');
                const title = document.getElementById('teacherModalTitle');
                const form = document.getElementById('teacherForm');

                if (teacher) {
                    title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³';
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name || '';
                    document.getElementById('teacherSubject').value = teacher.subject || '';
                    document.getElementById('teacherPhone').value = teacher.phone || '';
                    document.getElementById('teacherImage').value = teacher.image || '';
                    document.getElementById('teacherBio').value = teacher.bio || '';
                } else {
                    title.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯';
                    form.reset();
                    document.getElementById('teacherId').value = '';
                }
            }

            function closeTeacherModal() {
                document.getElementById('teacherModal').classList.add('hidden');
            }

            document.getElementById('teacherForm').onsubmit = async (e) => {
                e.preventDefault();
                const teacherId = document.getElementById('teacherId').value;
                const username = document.getElementById('teacherUsername').value;
                const password = document.getElementById('teacherPassword').value;

                const data = {
                    name: document.getElementById('teacherName').value,
                    subject: document.getElementById('teacherSubject').value,
                    phone: document.getElementById('teacherPhone').value,
                    image: document.getElementById('teacherImage').value,
                    bio: document.getElementById('teacherBio').value,
                    username: username,
                    role: 'teacher',
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (teacherId) {
                        if (password) data.password = password;
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.ADMINS, teacherId, data);
                    } else {
                        if (!password) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }
                        data.password = password;
                        data.createdAt = new Date().toISOString();
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.ADMINS, ID.unique(), data);
                    }
                    closeTeacherModal();
                    fetchTeachers();
                } catch (err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + err.message);
                }
            };

            let allTeachers = [];
            async function fetchTeachers() {
                const grid = document.getElementById('teachers-grid');
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [
                        Query.equal('role', 'teacher')
                    ]);
                    allTeachers = response.documents;
                    grid.innerHTML = response.documents.map(t => {
                        return `
                                    <div class="bg-white dark:bg-[#1a2428] rounded-[2rem] p-6 border border-gray-100 dark:border-gray-800 shadow-sm group">
                                        <div class="flex items-center gap-4 mb-4">
                                            <img src="${t.image || 'https://via.placeholder.com/100'}" class="size-16 rounded-2xl object-cover">
                                            <div>
                                                <h3 class="font-black text-secondary dark:text-white">${t.name}</h3>
                                                <p class="text-primary text-xs font-bold">${t.subject}</p>
                                            </div>
                                        </div>
                                        <p class="text-gray-400 text-xs font-bold mb-6 line-clamp-2">${t.bio || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                                        <div class="flex gap-2">
                                            <button onclick='openTeacherModal(${JSON.stringify({ id: t.$id, ...t }).replace(/'/g, "&apos;")})' class="btn-secondary flex-1 text-xs py-2">ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button onclick="deleteTeacher('${t.$id}')" class="btn-icon btn-icon-danger"><span class="material-symbols-outlined text-sm">delete</span></button>
                                        </div>
                                    </div>
                                `;
                    }).join('');
                } catch (e) {
                    console.error('Error fetching teachers:', e);
                }
            }

            async function deleteTeacher(id) {
                if ((await Swal.fire({ text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³ØŸ', icon: 'warning', showCancelButton: true })).isConfirmed) {
                    try {
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.ADMINS, id);
                        fetchTeachers();
                    } catch (e) {
                        alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³');
                    }
                }
            }

            // --- Users Management ---
            function openUserModal() {
                document.getElementById('userModal').classList.remove('hidden');
                document.getElementById('userForm').reset();
            }
            function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

            document.getElementById('userForm').onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    username: document.getElementById('username').value,
                    password: document.getElementById('userPassword').value,
                    role: document.getElementById('userRole').value,
                    createdAt: new Date().toISOString()
                };
                try {
                    // Check if username exists
                    const existing = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [
                        Query.equal('username', data.username)
                    ]);
                    if (existing.documents.length > 0) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');

                    await databases.createDocument(DATABASE_ID, COLLECTIONS.ADMINS, ID.unique(), data);
                    closeUserModal();
                    fetchUsers();
                } catch (err) {
                    alert('Ø®Ø·Ø£: ' + err.message);
                }
            }

            async function fetchUsers() {
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [
                        Query.limit(100)
                    ]);
                    const list = response.documents;
                    const usersCountEl = document.getElementById('usersCount');
                    if (usersCountEl) usersCountEl.textContent = list.length;

                    const table = document.getElementById('users-table-body');
                    if (table) {
                        table.innerHTML = list.map(u => {
                            return `
                                <tr class="hover:bg-primary/5 transition-colors">
                                    <td class="px-8 py-5 whitespace-nowrap">
                                        <div class="flex items-center gap-3">
                                            <div class="size-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center text-primary">
                                                <span class="material-symbols-outlined">shield_person</span>
                                            </div>
                                            <div>
                                                <p class="font-bold text-secondary dark:text-white text-sm">${u.name || u.username}</p>
                                                <p class="text-[10px] text-gray-400 font-bold">${u.username}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-8 py-5">
                                        <span class="px-3 py-1 ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-orange-100 text-orange-600'} rounded-lg text-[10px] font-black">
                                            ${u.role === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„ ÙƒØ§Ù…Ù„' : 'Ù…Ø¯Ø±Ø³'}
                                        </span>
                                    </td>
                                    <td class="px-8 py-5">
                                        <div class="flex items-center gap-2">
                                            <span class="size-2 rounded-full bg-green-500"></span>
                                            <span class="text-xs font-bold text-gray-500">Ù†Ø´Ø·</span>
                                        </div>
                                    </td>
                                    <td class="px-8 py-5 text-center">
                                        <button onclick="deleteUser('${u.$id}')" class="btn-icon btn-icon-danger">
                                            <span class="material-symbols-outlined text-lg">delete</span>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                } catch (e) {
                    console.error("Error fetching users:", e);
                }
            }

            async function deleteUser(id) {
                if ((await Swal.fire({ text: 'Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ', icon: 'warning', showCancelButton: true })).isConfirmed) {
                    try {
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.ADMINS, id);
                        fetchUsers();
                    } catch (e) { alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); }
                }
            }

            // --- Unified Theme Logic ---
            const themeToggle = document.getElementById('darkModeToggleSidebar');
            function updateThemeUI(isDark) {
                const icon = themeToggle?.querySelector('.theme-icon');
                if (icon) icon.textContent = isDark ? 'light_mode' : 'dark_mode';
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                }
            }
            if (themeToggle) {
                themeToggle.onclick = () => {
                    const isDark = !document.documentElement.classList.contains('dark');
                    localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
                    updateThemeUI(isDark);
                };
            }
            // Sync UI state with current theme
            updateThemeUI(document.documentElement.classList.contains('dark'));

            function renderApplicants(list) {
                const isTeacher = sessionStorage.getItem('user_role') === 'teacher';
                const isAdmin = !isTeacher;

                applicantCount.textContent = list.length;
                if (list.length === 0) {
                    tableContainer.innerHTML = '<div class="p-20 text-center text-gray-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ</div>';
                    return;
                }

                // Headers
                const paymentHeader = isAdmin ? '<th class="px-6 py-4 text-center">Ø§Ù„Ø¯ÙØ¹</th>' : '';

                let html = `
                <div class="overflow-x-auto rounded-3xl border border-gray-100 dark:border-gray-800">
                    <table class="w-full text-right border-collapse bg-white dark:bg-[#151e22]">
                    <thead class="bg-gray-50 border-b border-gray-100 dark:border-gray-800 uppercase text-[10px] font-black text-gray-500">
                        <tr>
                            <th class="px-6 py-4 text-right">Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø§Ù‚Ø©</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„ØªØ®ØµØµ</th>
                            ${paymentHeader}
                            <th class="px-6 py-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            <th class="px-6 py-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50 dark:divide-gray-800">
                `;

                list.forEach(applicant => {
                    const date = applicant.timestamp ? new Date(applicant.timestamp) : null;

                    // Timer Logic
                    let timerHtml = '<span class="text-gray-400">--</span>';
                    if (date) {
                        const subDays = getSubscriptionDays(applicant.plan);
                        const expiryDate = new Date(date.getTime() + (subDays * 24 * 60 * 60 * 1000));
                        const now = new Date();
                        const diff = expiryDate - now;
                        if (diff > 0) {
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const color = days < 5 ? 'text-orange-500' : 'text-green-500';
                            timerHtml = `<span class="font-bold text-xs ${color}">${days} ÙŠÙˆÙ…</span>`; // removed duplicate line
                        } else {
                            timerHtml = `<span class="font-bold text-xs text-red-500">Ù…Ù†ØªÙ‡ÙŠ</span>`;
                        }
                    }

                    // Payment Cell
                    const paymentCell = isAdmin ? `
                        <td class="px-6 py-5 whitespace-nowrap text-center">
                            <button onclick="togglePayment('${applicant.id}', '${applicant.paymentStatus}')" 
                                class="btn-icon size-10 flex mx-auto ${applicant.paymentStatus === 'paid' ? 'btn-icon-success' : 'btn-icon-primary'}">
                                <span class="material-symbols-outlined text-lg">${applicant.paymentStatus === 'paid' ? 'check' : 'payments'}</span>
                            </button>
                        </td>` : '';

                    html += `
                    <tr class="hover:bg-primary/5 transition-colors group border-b border-gray-50 dark:border-gray-800/50 last:border-none">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="size-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center text-gray-400 group-hover:bg-primary/20 group-hover:text-primary transition-all shadow-sm">
                                    <span class="material-symbols-outlined text-lg">person</span>
                                </div>
                                <div class="flex flex-col">
                                    <h4 class="font-bold text-secondary dark:text-white text-sm mb-0.5">${applicant.name}</h4>
                                    <span class="text-[10px] text-gray-400 font-bold bg-gray-50 dark:bg-gray-800 px-2 py-0.5 rounded-lg w-fit border border-gray-100 dark:border-gray-700/50">${isAdmin ? (applicant.plan || '--') : 'Ù…Ø³Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ'}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="px-3 py-1.5 bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-gray-500 dark:text-gray-400 rounded-lg text-[10px] font-black shadow-sm">
                                ${applicant.specialization || '-'}
                            </span>
                        </td>
                        ${paymentCell}
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="relative w-32">
                                <select onchange="updateStatus('${applicant.id}', this.value)" 
                                    class="w-full appearance-none pl-3 pr-8 py-2 rounded-xl text-[10px] font-black cursor-pointer transition-all border focus:ring-2 focus:ring-primary/20 hover:shadow-sm ${applicant.status === 'Ù†Ø´Ø·' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-gray-50 text-gray-500 border-gray-200'}">
                                    <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${applicant.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>Waitlist</option>
                                    <option value="Ù†Ø´Ø·" ${applicant.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Active</option>
                                    <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©" ${applicant.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'selected' : ''}>Help</option>
                                    <option value="Ù…ØªÙˆÙ‚Ù" ${applicant.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Paused</option>
                                    <option value="Ù…Ù†Ø³Ø­Ø¨" ${applicant.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'selected' : ''}>Dropped</option>
                                </select>
                                <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-[10px] opacity-60 pointer-events-none">expand_more</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">${timerHtml}</td>
                        <td class="px-6 py-5 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="viewApplicant('${applicant.id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </button>
                                ${isAdmin ? `
                                <button onclick="openInternConversionModal('${applicant.id}', '${applicant.name || ''}', 'APPLICANTS', '${applicant.specialization || ''}')" class="btn-icon btn-icon-warning" title="ØªØ­ÙˆÙŠÙ„ Ù„Ù…ØªØ¯Ø±Ø¨">
                                    <span class="material-symbols-outlined text-lg">model_training</span>
                                </button>
                                <button onclick="deleteApplicant('${applicant.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                tableContainer.innerHTML = html;
            }

            async function assignTeacher(applicantId, teacherId) {
                try {
                    const teacher = allTeachers.find(t => t.$id === teacherId);
                    const teacherName = teacher ? teacher.name : '';
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, applicantId, {
                        teacherId: teacherId,
                        teacherName: teacherName
                    });
                    // Refresh not needed if we trust UI update, but safer to refresh
                } catch (e) {
                    alert("ÙØ´Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯Ø±Ø³");
                    console.error(e);
                }
            }

            function renderConsultations() {
                const term = document.getElementById('consultationSearchInput')?.value.toLowerCase() || "";
                const list = applicants.filter(a => a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const filtered = list.filter(a =>
                    a.name?.toLowerCase().includes(term) ||
                    a.specialization?.toLowerCase().includes(term) ||
                    a.phone?.includes(term)
                );

                const container = document.getElementById('consultation-table-container');
                document.querySelector('.consultation-count-badge').textContent = `${filtered.length} Ø·Ù„Ø¨`;

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="p-20 text-center text-gray-400 font-bold">${term ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ´Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹'}</div>`;
                    return;
                }

                let html = `
                <table class="w-full text-right border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-100 dark:border-gray-800 uppercase text-[10px] font-black text-gray-500">
                        <tr>
                            <th class="px-6 py-4 text-right">ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡</th>
                            <th class="px-6 py-4 text-right">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-6 py-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50 dark:divide-gray-800">
            `;

                filtered.forEach(a => {
                    html += `
                    <tr class="hover:bg-primary/5 transition-colors group">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="size-8 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center">
                                    <span class="material-symbols-outlined text-sm">event_available</span>
                                </div>
                                <span class="font-bold text-secondary text-sm">${a.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-500 rounded-full text-[10px] font-black">
                                ${a.specialization || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                            </span>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap font-bold text-xs" dir="ltr">
                            ${a.phone || '--'}
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <select onchange="updateStatus('${a.id}', this.value)" 
                                class="text-[10px] font-black border-none rounded-lg py-1 px-2 cursor-pointer transition-all dark:bg-gray-800
                                ${a.status === 'Ù†Ø´Ø·' ? 'bg-green-100 text-green-600' :
                            a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'bg-blue-100 text-blue-600' :
                                a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'bg-yellow-100 text-yellow-600' :
                                    a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'bg-red-100 text-red-600' :
                                        a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'bg-gray-200 text-gray-700' : 'bg-gray-100 text-gray-500'}">
                                <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>Waitlist ğŸ”µ</option>
                                <option value="Ù†Ø´Ø·" ${a.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Active ğŸŸ¢</option>
                                <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©" ${a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'selected' : ''}>Needs Help ğŸŸ¡</option>
                                <option value="Ù…ØªÙˆÙ‚Ù" ${a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Paused ğŸ”´</option>
                                <option value="Ù…Ù†Ø³Ø­Ø¨" ${a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'selected' : ''}>Dropped âš«</option>
                            </select>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="viewApplicant('${a.id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </button>
                                <a href="https://wa.me/${formatWhatsAppPhone(a.phone)}" target="_blank" class="btn-icon btn-icon-success" title="ÙˆØ§ØªØ³Ø§Ø¨">
                                    <span class="material-symbols-outlined text-lg">chat</span>
                                </a>
                                <button onclick="openConvertModal('${a.id}', '${a.name || ''}', '${a.specialization || ''}')" class="btn-icon btn-icon-warning" title="ØªØ­ÙˆÙŠÙ„ Ù„Ø·Ø§Ù„Ø¨">
                                    <span class="material-symbols-outlined text-lg">upgrade</span>
                                </button>
                                <button onclick="openInternConversionModal('${a.id}', '${a.name || ''}', 'APPLICANTS', '${a.specialization || ''}')" class="btn-icon btn-icon-primary" title="ØªØ­ÙˆÙŠÙ„ Ù„Ù…ØªØ¯Ø±Ø¨">
                                    <span class="material-symbols-outlined text-lg">model_training</span>
                                </button>
                                <button onclick="deleteApplicant('${a.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function exportConsultationsToExcel() {
                const list = applicants.filter(a => a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const wb = XLSX.utils.book_new();
                const ws_data = [
                    ["Ø§Ù„Ø§Ø³Ù…", "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡", "Ø§Ù„Ø­Ø§Ù„Ø©", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨"]
                ];
                list.forEach(a => {
                    ws_data.push([
                        a.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        a.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        a.specialization || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        a.status || 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                        a.timestamp ? new Date(a.timestamp.seconds * 1000).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©");
                XLSX.writeFile(wb, "bosla-consultations.xlsx");
            }

            function openConvertModal(id, name, specialization) {
                document.getElementById('convertApplicantId').value = id;
                document.getElementById('convertApplicantName').textContent = name;
                document.getElementById('convertSpecialization').value = specialization || "Web Development";
                document.getElementById('convertModal').classList.remove('hidden');
            }

            function closeConvertModal() {
                document.getElementById('convertModal').classList.add('hidden');
            }

            document.getElementById('convertForm').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('convertApplicantId').value;
                const specialization = document.getElementById('convertSpecialization').value;
                const plan = document.getElementById('convertPlan').value;

                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, {
                        specialization: specialization,
                        plan: plan,
                        status: 'Ù†Ø´Ø·', // Set as active student
                        timestamp: new Date().toISOString() // Reset date to subscription start
                    });

                    closeConvertModal();
                    alert('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ØªØ¬Ø¯Ù‡ Ø§Ù„Ø¢Ù† ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨.');

                    // Switch to students section
                    switchSection('applicants');
                    fetchApplicants(); // Refresh the list
                } catch (err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ' + err.message);
                }
            };

            async function updateField(id, field, value) {
                // If value hasn't changed from what's in memory, don't prompt (avoid blur loops)
                const app = applicants.find(a => a.id === id);
                if (app && app[field] == value) return;

                try {
                    const data = {};
                    data[field] = value;
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, data);
                    // Update local state
                    if (app) app[field] = value;
                } catch (error) {
                    console.error("Error updating field", error);
                }
            }

            async function viewApplicant(id) {
                try {
                    const a = await databases.getDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id);
                    const timestampDate = a.timestamp ? new Date(a.timestamp) : new Date();
                    const autoStart = timestampDate.toLocaleDateString('ar-EG');
                    const subDays = getSubscriptionDays(a.plan);
                    const autoEnd = new Date(timestampDate.getTime() + subDays * 24 * 60 * 60 * 1000).toLocaleDateString('ar-EG');

                    const startDate = a.subscriptionStart || autoStart;
                    const endDate = a.subscriptionEnd || autoEnd;

                    const isConsultation = a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©';

                    document.getElementById('applicantDetails').innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Right Column: Personal & Basic Info -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-primary">person</span>
                                    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                                </h3>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
                                        <p class="font-bold text-secondary dark:text-white text-base">${a.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
                                        <div class="flex items-center gap-2">
                                            <p class="font-bold text-secondary dark:text-white text-base" dir="ltr">${a.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                                            <a href="https://wa.me/${formatWhatsAppPhone(a.phone)}" target="_blank" class="text-green-500 hover:scale-110 transition-transform">
                                                <span class="material-symbols-outlined text-lg">chat</span>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡</span>
                                        <p class="font-bold text-primary text-base">${a.specialization || '--'}</p>
                                    </div>
                                    
                                    ${!isConsultation ? `
                                    <div class="space-y-1 pt-2 border-t border-gray-100 dark:border-gray-800">
                                        <span class="text-[10px] font-black text-orange-500 uppercase tracking-widest">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø³Ø§Ø¨</span>
                                        <div class="flex gap-2">
                                            <input type="text" value="${a.password || ''}" placeholder="ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
                                                class="flex-1 h-10 bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700 rounded-xl px-3 text-xs font-bold"
                                                onblur="updateField('${id}', 'password', this.value)">
                                        </div>
                                    </div>` : ''}

                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</span>
                                        <p class="font-bold text-secondary dark:text-white text-sm">${a.timestamp ? new Date(a.timestamp).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-orange-500">traffic</span>
                                    Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
                                </h3>
                                <select onchange="updateStatus('${id}', this.value)" 
                                    class="w-full text-xs font-black border-none rounded-xl py-3 px-4 cursor-pointer transition-all dark:bg-gray-800
                                    ${a.status === 'Ù†Ø´Ø·' ? 'bg-green-100 text-green-600' :
                            a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'bg-blue-100 text-blue-600' :
                                a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'bg-yellow-100 text-yellow-600' :
                                    a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'bg-red-100 text-red-600' :
                                        a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'bg-gray-200 text-gray-700' : 'bg-gray-100 text-gray-500'}">
                                    <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>Waitlist ğŸ”µ</option>
                                    <option value="Ù†Ø´Ø·" ${a.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Active ğŸŸ¢</option>
                                    <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©" ${a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'selected' : ''}>Needs Help ğŸŸ¡</option>
                                    <option value="Ù…ØªÙˆÙ‚Ù" ${a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Paused ğŸ”´</option>
                                    <option value="Ù…Ù†Ø³Ø­Ø¨" ${a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'selected' : ''}>Dropped âš«</option>
                                </select>
                            </div>

                            ${!isConsultation ? `
                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-purple-500">psychology</span>
                                    Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„
                                </h3>
                                <select id="teacherAssignmentSelect" onchange="updateField('${id}', 'teacherId', this.value)" 
                                    class="w-full text-xs font-black border-none rounded-xl py-3 px-4 cursor-pointer transition-all dark:bg-gray-800 bg-white">
                                    <option value="">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
                                </select>
                            </div>

                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-blue-500">payments</span>
                                    Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯ÙØ¹
                                </h3>
                                <div class="space-y-3">
                                    <input type="text" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©" value="${a.plan || ''}" 
                                        class="w-full h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                        onblur="updateField('${id}', 'plan', this.value)">
                                    <div class="flex gap-2">
                                        <input type="text" placeholder="Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" value="${startDate}" 
                                            class="w-1/2 h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'subscriptionStart', this.value)">
                                        <input type="text" placeholder="Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" value="${endDate}" 
                                            class="w-1/2 h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'subscriptionEnd', this.value)">
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-xl border border-gray-100 dark:border-gray-600">
                                        <span class="text-[10px] font-black text-gray-400">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</span>
                                        <button onclick="togglePayment('${id}', '${a.paymentStatus}')" 
                                            class="px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${a.paymentStatus === 'paid' ? 'bg-green-500 text-white' : 'bg-red-100 text-red-500'}">
                                            ${a.paymentStatus === 'paid' ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹' : 'Ù„Ù… ÙŠØ¯ÙØ¹'}
                                        </button>
                                    </div>
                                </div>
                            </div>` : ''}
                        </div>

                        <!-- Left Column: Detailed Info -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Info Bio Section -->
                            <div class="bg-primary/5 dark:bg-primary/10 p-6 rounded-3xl border border-primary/10 dark:border-primary/20">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white mb-3">
                                    <span class="material-symbols-outlined text-primary">psychology_alt</span>
                                    Ù„Ù…Ø§Ø°Ø§ ÙŠØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø¨ÙˆØµÙ„Ø©ØŸ
                                </h3>
                                <div class="bg-white/50 dark:bg-black/20 p-4 rounded-2xl">
                                    <p class="text-sm font-bold text-secondary dark:text-gray-300 leading-relaxed whitespace-pre-wrap">
                                        ${a.bio || 'Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø©'}
                                    </p>
                                </div>
                            </div>

                            ${!isConsultation ? `
                            <!-- Target Section -->
                            <div class="space-y-4">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                    <span class="material-symbols-outlined text-primary">target</span>
                                    ğŸ¯ Ù‡Ø¯Ù Ø§Ù„Ø·Ø§Ù„Ø¨
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ù‡Ø¯ÙÙ‡ Ø®Ù„Ø§Ù„ 3 Ø´Ù‡ÙˆØ±</span>
                                        <textarea class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[80px]"
                                            onblur="updateField('${id}', 'goal3months', this.value)">${a.goal3months || ''}</textarea>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ù‡Ø¯ÙÙ‡ Ø®Ù„Ø§Ù„ 6 Ø´Ù‡ÙˆØ±</span>
                                        <textarea class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[80px]"
                                            onblur="updateField('${id}', 'goal6months', this.value)">${a.goal6months || ''}</textarea>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <span class="text-[10px] font-black text-gray-400">Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ù„Ù… (Ø´ØºÙ„ / ÙØ±ÙŠÙ„Ø§Ù†Ø³ / ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø§Øª)</span>
                                    <input type="text" value="${a.learningReason || ''}" 
                                        class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                        onblur="updateField('${id}', 'learningReason', this.value)">
                                </div>
                            </div>

                            <!-- Learning Path Section -->
                            <div class="space-y-4">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                    <span class="material-symbols-outlined text-primary">map</span>
                                    ğŸ—ºï¸ Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù… (Learning Path)
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±</span>
                                        <input type="text" value="${a.pathName || a.specialization || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'pathName', this.value)">
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</span>
                                        <input type="number" value="${a.totalWeeks || 0}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'totalWeeks', this.value)">
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                                        <input type="number" value="${a.currentWeek || 1}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'currentWeek', this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- Progress & Evaluation -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                        <span class="material-symbols-outlined text-primary">analytics</span>
                                        ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
                                    </h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-[10px] font-black text-gray-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (%)</span>
                                            <span class="text-xs font-black text-primary">${a.progressPercent || 0}%</span>
                                        </div>
                                        <input type="range" value="${a.progressPercent || 0}" min="0" max="100" class="w-full accent-primary" 
                                            oninput="this.previousElementSibling.querySelector('span:last-child').innerText = this.value + '%'"
                                            onchange="updateField('${id}', 'progressPercent', this.value)">
                                        <input type="text" placeholder="Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆ ØªÙ… Ù…Ø´Ø§Ù‡Ø¯Ù‡" value="${a.lastVideo || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'lastVideo', this.value)">
                                    </div>
                                </div>
                            </div>` : `
                            <!-- Consultation Specific Info -->
                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-primary">info</span>
                                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©
                                </h3>
                                <p class="text-sm text-gray-500 font-bold">Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù‚Ø¯Ù… ÙƒØ§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ù…Ø´ØªØ±Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø²Ø± "ØªØ­ÙˆÙŠÙ„ Ù„Ø·Ø§Ù„Ø¨" Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</p>
                            </div>
                            `}

                            <!-- General Notes Shared -->
                            <div class="space-y-4">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                    <span class="material-symbols-outlined text-primary">notes</span>
                                    ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©
                                </h3>
                                <textarea placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…..." class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-4 text-xs font-bold focus:ring-primary min-h-[100px]"
                                    onblur="updateField('${id}', 'extraNotes', this.value)">${a.extraNotes || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div id="pdf-ignore" class="flex flex-wrap gap-3 pt-6 border-t border-gray-100 dark:border-gray-800">
                        <button onclick="renewSubscription('${id}')" class="btn-secondary px-6 text-xs">
                            <span class="material-symbols-outlined text-sm">autorenew</span>
                            ØªØ¬Ø¯ÙŠØ¯ (30 ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯Ø©)
                        </button>
                        <button onclick="sendQuickMsg('${a.phone}', 'welcome', '${a.name}')" class="btn-secondary px-6 text-xs text-green-600 dark:text-green-400">
                            <span class="material-symbols-outlined text-sm">verified</span>
                            Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ ÙˆÙ‚Ø¨ÙˆÙ„
                        </button>
                        <button onclick="downloadProfilePDF('${id}', '${a.name}')" class="btn-secondary px-6 text-xs text-red-500">
                            <span class="material-symbols-outlined text-sm">picture_as_pdf</span>
                            ØªØ­Ù…ÙŠÙ„ PDF
                        </button>
                        <button onclick="openInternConversionModal('${id}', '${a.name}', 'APPLICANTS', '${a.specialization || ''}')" class="btn-primary px-6 text-xs">
                            <span class="material-symbols-outlined text-sm">model_training</span>
                            ØªØ­ÙˆÙŠÙ„ Ù„Ù…ØªØ¯Ø±Ø¨ (Intern)
                        </button>
                    </div>
                `;

                    document.getElementById('modalActionContainer').innerHTML = `
                    <a href="https://wa.me/${formatWhatsAppPhone(a.phone)}" target="_blank" class="btn-primary px-8">
                        <span class="material-symbols-outlined">chat</span>
                        ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨
                    </a>
                `;

                    document.getElementById('applicantModal').classList.remove('hidden');

                    // Populate teacher assignment dropdown
                    const tSnap = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [Query.equal("role", "teacher")]);
                    const select = document.getElementById('teacherAssignmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>' +
                            tSnap.documents.map(tDoc => `<option value="${tDoc.$id}" ${a.teacherId === tDoc.$id ? 'selected' : ''}>${tDoc.username}</option>`).join('');
                    }
                } catch (e) { console.error(e); }
            }

            async function downloadProfilePDF(id, name) {
                const element = document.getElementById('applicantDetails');
                const opt = {
                    margin: [10, 10],
                    filename: `Ø¨Ø±ÙˆÙÙŠÙ„_${name}_Ø¨ÙˆØµÙ„Ø©.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        scrollY: 0
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Temporary styles to make things look perfect in PDF
                const pdfIgnore = document.getElementById('pdf-ignore');
                const originalStyle = element.getAttribute('style') || '';

                // Apply PDF-specific styling
                element.style.padding = '30px';
                element.style.backgroundColor = '#ffffff';
                element.style.direction = 'rtl';

                if (pdfIgnore) pdfIgnore.style.display = 'none';

                try {
                    // Ensure all fonts and styles are loaded
                    await html2pdf().set(opt).from(element).save();
                } catch (err) {
                    console.error('PDF Generation Error:', err);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ PDF');
                } finally {
                    // Restore UI
                    if (pdfIgnore) pdfIgnore.style.display = 'flex';
                    element.setAttribute('style', originalStyle);
                }
            }

            function closeModal() {
                document.getElementById('applicantModal').classList.add('hidden');
            }



            async function deleteApplicant(id) {
                if (!(await Swal.fire({ text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ', icon: 'warning', showCancelButton: true })).isConfirmed) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id);
                    applicants = applicants.filter(a => a.id !== id);
                    filter(); // Refresh view
                    Swal.fire('ØªÙ…!', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                } catch (error) {
                    // If document already deleted (404), just remove from UI
                    if (error.code === 404 || error.toString().includes('404')) {
                        applicants = applicants.filter(a => a.id !== id);
                        filter();
                        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø­Ø°ÙˆÙ Ø¨Ø§Ù„ÙØ¹Ù„ (Ø±Ø¨Ù…Ø§ ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹).', 'info');
                    } else {
                        console.error("Error deleting applicant:", error);
                        Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message, 'error');
                    }
                }
            }

            async function updateStatus(id, newStatus) {
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, {
                        status: newStatus
                    });
                    const app = applicants.find(a => a.id === id);
                    if (app) app.status = newStatus;
                    renderApplicants(applicants);
                } catch (error) {
                    console.error("Error updating status: ", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: " + error.message);
                }
            }

            async function togglePayment(id, currentStatus) {
                const newStatus = currentStatus === 'paid' ? 'unpaid' : 'paid';
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, { paymentStatus: newStatus });
                    const app = applicants.find(a => a.id === id);
                    if (app) app.paymentStatus = newStatus;
                    renderApplicants(applicants);
                } catch (error) { alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹"); }
            }

            async function saveNotes(id, notes) {
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, { notes: notes });
                    const app = applicants.find(a => a.id === id);
                    if (app) app.notes = notes;
                } catch (error) { console.error("Error saving notes", error); }
            }

            async function renewSubscription(id) {
                const app = applicants.find(a => a.id === id);
                if (!app) return;

                if (!(await Swal.fire({
                    text: `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§Ùƒ ${app.name}ØŸ Ø³ØªØ¨Ø¯Ø£ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¢Ù†.`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØªØ¬Ø¯ÙŠØ¯',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                })).isConfirmed) return;

                try {
                    const subDays = getSubscriptionDays(app.plan);
                    const now = new Date();
                    const expiry = new Date(now.getTime() + subDays * 24 * 60 * 60 * 1000);

                    // Use a consistent format for the database, but since the rest of the app 
                    // uses ar-EG strings, we'll keep it for compatibility with the current filters/logic.
                    const startStr = now.toLocaleDateString('ar-EG');
                    const endStr = expiry.toLocaleDateString('ar-EG');

                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, {
                        timestamp: now.toISOString(),
                        paymentStatus: 'paid',
                        subscriptionStart: startStr,
                        subscriptionEnd: endStr
                    });

                    if (app) {
                        app.subscriptionStart = startStr;
                        app.subscriptionEnd = endStr;
                        app.paymentStatus = 'paid';
                    }

                    Swal.fire('ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯!', `ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù…Ø¯Ø© ${subDays} ÙŠÙˆÙ….`, 'success');
                    closeModal();
                    fetchApplicants();
                } catch (error) {
                    console.error("Renewal Error:", error);
                    Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: ' + error.message, 'error');
                }
            }

            function sendQuickMsg(phone, type, name) {
                let msg = "";
                if (type === 'welcome') {
                    msg = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name}! %0AÙ„Ù‚Ø¯ ØªÙ…Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØµÙ„Ø© ÙˆÙ‚Ø¨ÙˆÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†ÙƒÙˆÙ† Ù…Ø¹Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© ÙÙŠ Ù…Ø³Ø§Ø±Ùƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ.`;
                } else if (type === 'expiry') {
                    msg = `Ø¹Ø²ÙŠØ²ÙŠ ${name},%0A Ù†ÙˆØ¯ ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ø£Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø¨ÙˆØµÙ„Ø© Ø³ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.`;
                }
                window.open(`https://wa.me/${formatWhatsAppPhone(phone)}?text=${msg}`, '_blank');
            }

            // Theme Logic synced from head or previous session handled by head script
            async function deleteAllApplicants() {
                if (!(await Swal.fire({ text: 'ØªØ­Ø°ÙŠØ± Ø´Ø¯ÙŠØ¯! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.', icon: 'error', showCancelButton: true })).isConfirmed) return;

                const { value: confirmText } = await Swal.fire({
                    title: "ØªØ­Ø°ÙŠØ±!",
                    text: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø­Ø°Ù) Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±:',
                    input: 'text',
                    showCancelButton: true
                });
                const password = confirmText;
                if (password !== 'Ø­Ø°Ù') {
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.');
                    return;
                }

                const deleteAllBtn = document.getElementById('deleteAllBtn');
                const originalContent = deleteAllBtn.innerHTML;

                try {
                    deleteAllBtn.disabled = true;
                    deleteAllBtn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

                    // Appwrite doesn't have batch delete, so we do it in parallel
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.APPLICANTS, [Query.limit(100)]);
                    await Promise.all(response.documents.map(doc => databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, doc.$id)));

                    alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
                    fetchApplicants();
                } catch (error) {
                    console.error("Error deleting all applicants: ", error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù: ' + error.message);
                } finally {
                    deleteAllBtn.disabled = false;
                    deleteAllBtn.innerHTML = originalContent;
                }
            }

            document.getElementById('deleteAllBtn').onclick = deleteAllApplicants;

            function exportToExcel() {
                const wb = XLSX.utils.book_new();
                const ws_data = [
                    ["Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„ØªØ®ØµØµ", "Ø§Ù„Ø¨Ø§Ù‚Ø©", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¹Ù…Ø§Ù„", "Ù„Ù…Ø§Ø°Ø§ ÙŠØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…"]
                ];
                applicants.forEach(applicant => {
                    ws_data.push([
                        applicant.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.specialization || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.plan || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        applicant.portfolio || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.bio || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.timestamp ? new Date(applicant.timestamp.seconds * 1000).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†");
                XLSX.writeFile(wb, "elbosla-applicants.xlsx");
            }

            document.getElementById('exportBtn').onclick = exportToExcel;
            document.getElementById('resetSearchBtn').onclick = () => {
                searchInput.value = '';
                specializationFilter.value = '';
                document.getElementById('planFilter').value = '';
                document.getElementById('paymentFilter').value = '';
                filter();
            };

            specializationFilter.onchange = filter;
            document.getElementById('planFilter').onchange = filter;
            document.getElementById('paymentFilter').onchange = filter;
            searchInput.oninput = filter;
            document.getElementById('consultationSearchInput').oninput = renderConsultations;
            document.getElementById('exportConsultationsBtn').onclick = exportConsultationsToExcel;

            function filter() {
                const term = searchInput.value.toLowerCase();
                const spec = specializationFilter.value;
                const plan = document.getElementById('planFilter').value;
                const payment = document.getElementById('paymentFilter').value;

                // Separate Free Consultations from regular students
                const regularStudents = applicants.filter(a => a.plan !== 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');

                let filtered = regularStudents.filter(a => {
                    const matchTerm = (a.name || '').toLowerCase().includes(term) || (a.specialization || '').toLowerCase().includes(term) || (a.phone || '').includes(term);
                    const matchSpec = !spec || a.specialization === spec;
                    const matchPlan = !plan || a.plan === plan;
                    const matchPayment = !payment || (payment === 'paid' ? a.paymentStatus === 'paid' : a.paymentStatus !== 'paid');
                    return matchTerm && matchSpec && matchPlan && matchPayment;
                });

                // Update Dashboard Stats for Students section
                document.getElementById('activeCountStats').textContent = filtered.filter(a => a.status === 'Ù†Ø´Ø·').length;

                // Calc expiring
                const expiring = filtered.filter(a => {
                    if (!a.timestamp) return false;
                    const date = new Date(a.timestamp);
                    const expiryDate = new Date(date.getTime() + (30 * 24 * 60 * 60 * 1000));
                    const diff = (expiryDate - new Date()) / (1000 * 60 * 60 * 24);
                    return diff > 0 && diff < 5;
                }).length;
                document.getElementById('expiringCountStats').textContent = expiring;

                renderApplicants(filtered);
            }

            if (userRole === 'teacher') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                // Auto switch done by HTML 'active' class on section-applicants
            } else {
                fetchApplicants();
            }

            // --- Mobile Sidebar Toggle ---
            function toggleChatSidebar() {
                const sidebar = document.getElementById('chatSidebar');
                const overlay = document.getElementById('chatOverlay');
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');
            }

            // --- Chat Logic ---
            let activeChatId = null;
            let messagesUnsubscribe = null;

            function updateChatList() {
                const list = document.getElementById('chatList');
                const loggedInUserId = sessionStorage.getItem('user_doc_id'); // We'll need to set this on login

                // Filter applicants who have passwords (active students) or show all
                let activeStudents = applicants.filter(a => a.status === 'Ù†Ø´Ø·');

                // If teacher, restriction:
                if (userRole === 'teacher') {
                    activeStudents = activeStudents.filter(s => s.teacherId === loggedInUserId);
                }

                if (activeStudents.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 opacity-30 text-xs font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                    return;
                }

                list.innerHTML = activeStudents.map(student => `
                    <button onclick="selectChat('${student.id}', '${student.name}')" 
                        class="w-full flex items-center gap-3 p-3 rounded-2xl transition-all hover:bg-primary/5 group ${activeChatId === student.id ? 'bg-primary/10' : ''}">
                        <div class="size-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center text-primary group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-xl">person</span>
                        </div>
                        <div class="text-right overflow-hidden">
                            <p class="font-black text-sm text-secondary dark:text-white truncate">${student.name}</p>
                            <p class="text-[9px] font-bold text-gray-400 truncate">${student.specialization || 'Ø·Ø§Ù„Ø¨'}</p>
                        </div>
                    </button>
                `).join('');
            }


            function selectChat(studentId, studentName) {
                activeChatId = studentId;
                document.getElementById('activeChatTitle').textContent = studentName;
                document.getElementById('activeChatIcon').textContent = 'person';
                document.getElementById('meetingBtn').classList.remove('hidden');
                updateChatList();
                loadMessages(studentId);

                // On mobile, close sidebar after selection
                if (window.innerWidth < 1024) {
                    toggleChatSidebar();
                }
            }

            function loadMessages(studentId) {
                if (messagesUnsubscribe) messagesUnsubscribe();
                const chatMessages = document.getElementById('chatMessages');

                // Initial load
                databases.listDocuments(DATABASE_ID, COLLECTIONS.MESSAGES, [
                    Query.equal('senderId', studentId),
                    Query.orderAsc('timestamp')
                ]).then(response => {
                    renderMessagesUI(response.documents);
                });

                // Realtime subscription
                messagesUnsubscribe = client.subscribe(`databases.${DATABASE_ID}.collections.${COLLECTIONS.MESSAGES}.documents`, response => {
                    if (response.events.some(e => e.includes('.create'))) {
                        const m = response.payload;
                        if (m.senderId === studentId) {
                            // Fetch again or append locally
                            databases.listDocuments(DATABASE_ID, COLLECTIONS.MESSAGES, [
                                Query.equal('senderId', studentId),
                                Query.orderAsc('timestamp')
                            ]).then(res => renderMessagesUI(res.documents));
                        }
                    }
                });
            }

            function renderMessagesUI(docs) {
                const chatMessages = document.getElementById('chatMessages');
                if (docs.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-center opacity-20">
                            <span class="material-symbols-outlined text-6xl">waving_hand</span>
                            <p class="font-black mt-4">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${document.getElementById('activeChatTitle').textContent}</p>
                        </div>`;
                    return;
                }

                chatMessages.innerHTML = docs.map(m => {
                    const isAdmin = m.senderType === 'admin';

                    let content = `<p class="text-sm font-bold">${m.text || ''}</p>`;
                    if (m.type === 'audio') {
                        content = `<audio src="${m.audioUrl}" controls class="h-8 max-w-full"></audio>`;
                    } else if (m.type === 'meeting') {
                        content = `
                             <div class="bg-blue-600/10 dark:bg-blue-600/20 p-4 rounded-2xl border border-blue-600/20 text-center">
                                 <div class="flex items-center justify-center gap-2 mb-2">
                                     <img src="https://www.gstatic.com/images/branding/product/2x/meet_48dp.png" class="size-5" alt="Google Meet">
                                     <p class="text-[10px] font-black text-blue-600 dark:text-blue-400">Ø§Ø¬ØªÙ…Ø§Ø¹ Google Meet</p>
                                 </div>
                                 <a href="${m.meetingUrl}" target="_blank" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-[10px] font-black inline-block shadow-lg shadow-blue-600/20 transition-all hover:scale-105">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</a>
                             </div>`;
                    } else if (m.type === 'file') {
                        const isImage = m.fileType && m.fileType.startsWith('image/');
                        if (isImage) {
                            content = `<a href="${m.fileUrl}" target="_blank"><img src="${m.fileUrl}" class="rounded-xl max-w-full max-h-60 object-cover shadow-sm" alt="image"></a>`;
                        } else {
                            content = `
                                <a href="${m.fileUrl}" target="_blank" class="flex items-center gap-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all text-secondary dark:text-white">
                                    <span class="material-symbols-outlined text-primary">description</span>
                                    <div class="text-right overflow-hidden">
                                        <p class="text-[10px] font-black truncate max-w-[150px]">${m.fileName || 'Ù…Ù„Ù Ù…Ø±ÙÙ‚'}</p>
                                        <p class="text-[8px] opacity-60">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</p>
                                    </div>
                                </a>`;
                        }
                    }

                    const deleteBtn = (isAdmin && userRole === 'admin') ? `
                        <button onclick="deleteChatMessage('${m.$id}', '${m.fileUrl}')" class="text-red-400 hover:text-red-600 transition-colors mt-1">
                            <span class="material-symbols-outlined text-xs">delete</span>
                        </button>
                    ` : '';

                    return `
                        <div class="flex ${isAdmin ? 'justify-start' : 'justify-end'}">
                            <div class="max-w-[80%] p-4 rounded-2xl shadow-sm border ${isAdmin
                            ? 'bg-primary text-white border-primary rounded-tr-none'
                            : 'bg-white dark:bg-gray-800 text-secondary dark:text-white border-gray-100 dark:border-gray-700 rounded-tl-none'}">
                                ${content}
                                <div class="flex justify-between items-end gap-4">
                                    ${deleteBtn}
                                    <p class="text-[8px] mt-1 opacity-60 text-left" dir="ltr">${m.timestamp ? new Date(m.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : ''}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // --- Voice Recording Logic ---
            let mediaRecorder;
            let audioChunks = [];
            let recordInterval;

            document.getElementById('voiceBtn').onclick = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                    mediaRecorder.onstop = uploadVoice;

                    mediaRecorder.start();
                    showRecordingUI();
                } catch (err) {
                    alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");
                }
            };

            function showRecordingUI() {
                document.getElementById('chatForm').classList.add('hidden');
                document.getElementById('recordingStatus').classList.remove('hidden');
                let sec = 0;
                recordInterval = setInterval(() => {
                    sec++;
                    let m = Math.floor(sec / 60).toString().padStart(2, '0');
                    let s = (sec % 60).toString().padStart(2, '0');
                    document.getElementById('recordTimer').textContent = `${m}:${s} `;
                }, 1000);
            }

            function cancelRecording() {
                mediaRecorder.stop();
                mediaRecorder.onstop = null;
                hideRecordingUI();
            }

            function stopAndSendRecording() {
                mediaRecorder.stop();
                hideRecordingUI();
            }

            function hideRecordingUI() {
                document.getElementById('chatForm').classList.remove('hidden');
                document.getElementById('recordingStatus').classList.add('hidden');
                clearInterval(recordInterval);
                document.getElementById('recordTimer').textContent = "00:00";
            }

            async function uploadVoice() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const file = new File([audioBlob], `voice_${Date.now()}.webm`, { type: audioBlob.type });

                try {
                    const response = await storage.createFile('chats', ID.unique(), file);
                    const url = storage.getFileDownload('chats', response.$id);
                    await sendMsg({
                        type: 'audio',
                        audioUrl: url,
                        fileId: response.$id
                    });
                    if (activeChatId) loadMessages(activeChatId);
                } catch (err) {
                    console.error("Audio upload failed", err);
                }
                stopRecordingUI();
            }

            async function handleFileUpload(files) {
                if (!files || files.length === 0 || !activeChatId) return;

                for (let file of files) {
                    try {
                        const response = await storage.createFile('chats', ID.unique(), file);
                        const url = storage.getFileDownload('chats', response.$id);
                        await sendMsg({
                            type: 'file',
                            fileUrl: url,
                            fileName: file.name,
                            fileType: file.type,
                            fileId: response.$id
                        });
                        if (activeChatId) loadMessages(activeChatId);
                    } catch (err) {
                        console.error("Upload failed", err);
                        alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: " + file.name);
                    }
                }
                document.getElementById('fileInput').value = '';
            }

            async function deleteChatMessage(msgId, fileUrl) {
                if (!(await Swal.fire({ text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ', icon: 'warning', showCancelButton: true })).isConfirmed) return;
                try {
                    // 1. Delete message from Appwrite
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.MESSAGES, msgId);

                    // 2. Delete from Storage (optional but good practice)
                    if (fileUrl) {
                        try {
                            // Extract fileId from URL if possible, or store it in message
                            // Assuming URL contains fileId
                            const fileId = fileUrl.split('/').pop().split('?')[0];
                            await storage.deleteFile('chats', fileId);
                        } catch (e) {
                            console.warn("Could not delete from storage", e);
                        }
                    }
                    if (activeChatId) loadMessages(activeChatId);
                } catch (err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + err.message);
                }
            }

            async function sendMsg(data) {
                if (!activeChatId) return;
                const msg = {
                    ...data,
                    senderType: 'admin',
                    senderId: 'admin',
                    timestamp: new Date().toISOString()
                };
                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.MESSAGES, ID.unique(), msg);
                } catch (err) {
                    console.error("Error sending message:", err);
                }
            }

            async function startMeeting() {
                const { value: url } = await Swal.fire({
                    title: "Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹",
                    text: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¬ÙˆØ¬Ù„ Ù…ÙŠØª (Google Meet):",
                    input: 'text',
                    inputValue: "https://meet.google.com/",
                    showCancelButton: true
                });
                if (!url) return;

                if (!url.includes("meet.google.com") && !url.includes("http")) {
                    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­");
                    return;
                }

                await sendMsg({
                    type: 'meeting',
                    meetingUrl: url,
                    text: 'ØªÙ… Ø¨Ø¯Ø¡ Ø§Ø¬ØªÙ…Ø§Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Google Meet. ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¢Ù† Ù„Ù…Ù†Ø§Ù‚Ø´Ø© Ø£Ø³Ø¦Ù„ØªÙƒ.'
                });
            }

            document.getElementById('chatForm').onsubmit = async (e) => {
                e.preventDefault();
                const input = document.getElementById('chatInput');
                const text = input.value.trim();

                if (!text || !activeChatId) return;

                const msg = {
                    text: text,
                    senderType: 'admin',
                    senderId: 'admin', // or actual admin id
                    timestamp: new Date().toISOString()
                };

                input.value = '';
                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.MESSAGES, ID.unique(), msg);
                    loadMessages(activeChatId);
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
                }
            };







            // --- CONTENT CALENDAR LOGIC (ENHANCED) ---
            let currentDate = new Date();
            let selectedDateStr = "";
            let contentStore = {};
            let uploadedImages = [];
            let currentDayTasks = [];
            let selectedPlatforms = [];

            async function initCalendar() {
                renderCalendar();
                fetchGlobalTasks();

                // Start a timer to refresh reminders every minute for the countdown
                if (window.reminderInterval) clearInterval(window.reminderInterval);
                window.reminderInterval = setInterval(renderReminders, 60000);
            }

            async function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const monthYearLabel = document.getElementById('calendarMonthYear');
                if (!grid) return;

                grid.innerHTML = "";
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const monthName = currentDate.toLocaleDateString('ar-EG', { month: 'long' });
                monthYearLabel.innerText = `${monthName} ${year}`;

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Saturday start adjustment
                let emptyStartingCells = (firstDayOfMonth + 1) % 7;

                await fetchMonthContent(year, month);
                renderReminders();

                for (let i = 0; i < emptyStartingCells; i++) {
                    grid.innerHTML += `<div class="bg-gray-50/30 dark:bg-gray-900/10 border-gray-100 dark:border-gray-700"></div>`;
                }

                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = dateStr === todayStr;
                    const content = contentStore[dateStr] || null;

                    let contentPreview = "";
                    if (content) {
                        const hasImages = content.images && content.images.length > 0;
                        const statusColor = content.status === 'published' ? 'bg-green-500' : (content.status === 'ready' ? 'bg-primary' : 'bg-gray-400');

                        // Icons for platforms
                        let platformIcons = (content.platforms || []).map(p => {
                            const iconMap = { facebook: 'fab fa-facebook-f', instagram: 'fab fa-instagram', linkedin: 'fab fa-linkedin-in', whatsapp: 'fab fa-whatsapp' };
                            return `<i class="${iconMap[p]} text-[8px] opacity-70"></i>`;
                        }).join(' ');

                        contentPreview = `
                            <div class="mt-1 space-y-0.5 w-full">
                                <div class="flex items-center justify-between">
                                    <div class="flex gap-1">${platformIcons}</div>
                                    <span class="size-1 rounded-full ${statusColor}"></span>
                                </div>
                                <p class="text-[8px] font-bold text-gray-500 truncate mt-0.5 line-clamp-1 leading-tight">${content.notes || '...'}</p>
                                ${content.publishTime ? `<div class="flex items-center gap-1 text-[7px] text-primary font-bold"><span class="material-symbols-outlined text-[7px]">schedule</span>${content.publishTime}</div>` : ''}
                                <div class="flex gap-0.5 mt-0.5">
                                    ${(content.dayTasks || []).map(t => `<span class="task-dot ${t.done ? 'done' : 'pending'}"></span>`).join('')}
                                </div>
                            </div>
                        `;
                    }

                    grid.innerHTML += `
                        <div onclick="openContentModal('${dateStr}')" class="p-2 cursor-pointer relative ${isToday ? 'bg-primary/5' : ''} border-gray-100 dark:border-gray-700 flex flex-col items-start hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <span class="day-num text-[9px] font-black ${isToday ? 'text-primary' : 'text-gray-400'}">${day}</span>
                            <div class="flex-1 w-full overflow-hidden">
                                ${contentPreview}
                            </div>
                        </div>
                    `;
                }
            }

            function changeMonth(dir) {
                currentDate.setMonth(currentDate.getMonth() + dir);
                renderCalendar();
            }

            async function fetchMonthContent(year, month) {
                contentStore = {};
                const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(month + 1).padStart(2, '0')}-31`;

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, [
                        Query.greaterThanEqual('date', startDate),
                        Query.lessThanEqual('date', endDate)
                    ]);

                    response.documents.forEach(doc => {
                        contentStore[doc.date] = { id: doc.$id, ...doc };
                    });
                } catch (e) {
                    console.error("Failed to fetch calendar content", e);
                }
            }

            // --- Modal Logic ---
            function openContentModal(dateStr) {
                selectedDateStr = dateStr;
                const d = new Date(dateStr);
                document.getElementById('modalDateDisplay').innerText = d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });

                const content = contentStore[dateStr] || { notes: "", images: [], platforms: [], publishTime: "", dayTasks: [], status: "draft" };

                // Handle Metadata stored in notes logic
                let userNotes = content.notes;
                let status = "draft";
                currentDayTasks = [];

                try {
                    // Try to parse notes as JSON metadata
                    if (content.notes && (content.notes.startsWith('{') || content.notes.startsWith('['))) {
                        const meta = JSON.parse(content.notes);
                        userNotes = meta.userNotes || "";
                        status = meta.status || "draft";
                        currentDayTasks = meta.dayTasks || [];
                    } else {
                        userNotes = content.notes || "";
                    }
                } catch (e) {
                    userNotes = content.notes || "";
                }

                // Fallback if dayTasks exists in root (for future migration support)
                if (content.dayTasks && typeof content.dayTasks === 'string') {
                    try { currentDayTasks = JSON.parse(content.dayTasks); } catch (e) { }
                }

                document.getElementById('contentNotes').value = userNotes;
                document.getElementById('contentStatus').value = status;

                // Parse time for display 2:30 PM
                const timeStr = content.publishTime || "12:00 AM";
                const [time, period] = timeStr.split(' ');
                const [h, m] = time.split(':');
                document.getElementById('publishHour').value = h || "12";
                document.getElementById('publishMinute').value = m || "00";
                document.getElementById('publishPeriod').value = period || "AM";
                document.getElementById('contentStatus').value = content.status || "draft";
                try {
                    uploadedImages = content.images ? JSON.parse(content.images) : [];
                } catch (e) {
                    uploadedImages = [];
                }
                try {
                    selectedPlatforms = content.platforms ? JSON.parse(content.platforms) : [];
                } catch (e) { selectedPlatforms = []; }
                currentDayTasks = content.dayTasks ? [...content.dayTasks] : [];

                updatePlatformUI();
                renderDayTasks();
                renderContentImages();

                if (content.id) {
                    document.getElementById('deleteContentBtn').classList.remove('hidden');
                } else {
                    document.getElementById('deleteContentBtn').classList.add('hidden');
                }

                document.getElementById('contentModal').classList.remove('hidden');
            }

            function closeContentModal() {
                document.getElementById('contentModal').classList.add('hidden');
            }

            function togglePlatform(p) {
                const idx = selectedPlatforms.indexOf(p);
                if (idx > -1) selectedPlatforms.splice(idx, 1);
                else selectedPlatforms.push(p);
                updatePlatformUI();
            }

            function updatePlatformUI() {
                document.querySelectorAll('.platform-btn').forEach(btn => {
                    if (selectedPlatforms.includes(btn.dataset.platform)) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }

            async function addDayTask() {
                const { value: text } = await Swal.fire({
                    title: "Ù…Ù‡Ù…Ø© Ù…Ù‚Ø§Ø¨Ù„Ø©",
                    text: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©:",
                    input: 'text',
                    showCancelButton: true
                });
                if (!(text)) return;
                currentDayTasks.push({ text, done: false });
                renderDayTasks();
            }

            function renderDayTasks() {
                const list = document.getElementById('dayTaskList');
                list.innerHTML = currentDayTasks.map((t, i) => `
                    <div class="flex items-center gap-3 bg-gray-50 dark:bg-gray-900 p-3 rounded-xl">
                        <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleDayTask(${i})" class="rounded text-primary focus:ring-primary size-4">
                        <span class="text-xs font-bold ${t.done ? 'line-through opacity-50' : 'text-secondary dark:text-white'}">${t.text}</span>
                        <button onclick="removeDayTask(${i})" class="mr-auto text-red-500 opacity-0 group-hover:opacity-100 transition-all"><span class="material-symbols-outlined text-sm">delete</span></button>
                    </div>
                `).join('');
            }

            function toggleDayTask(i) {
                currentDayTasks[i].done = !currentDayTasks[i].done;
                renderDayTasks();
            }

            function removeDayTask(i) {
                currentDayTasks.splice(i, 1);
                renderDayTasks();
            }

            function renderContentImages() {
                const grid = document.getElementById('contentImageGrid');
                const uploadLabel = grid.querySelector('label');
                grid.querySelectorAll('.img-preview').forEach(el => el.remove());
                uploadedImages.forEach((url, index) => {
                    const div = document.createElement('div');
                    div.className = "img-preview relative aspect-square rounded-2xl overflow-hidden shadow-md group border border-gray-100 dark:border-gray-700";
                    div.innerHTML = `<img src="${url}" class="w-full h-full object-cover">
                        <button onclick="removeContentImage(${index})" class="absolute top-1 right-1 size-6 bg-red-500 text-white rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                        <span class="material-symbols-outlined text-xs">close</span></button>`;
                    grid.insertBefore(div, uploadLabel);
                });
            }

            async function handleContentImages(files) {
                if (!files.length) return;
                const saveBtn = document.getElementById('saveContentBtn');
                saveBtn.disabled = true;
                for (let file of files) {
                    try {
                        const response = await storage.createFile('calendar', ID.unique(), file);
                        const url = storage.getFileDownload('calendar', response.$id);
                        uploadedImages.push(url);
                    } catch (e) { console.error(e); }
                }
                renderContentImages();
                saveBtn.disabled = false;
            }

            function removeContentImage(index) {
                uploadedImages.splice(index, 1);
                renderContentImages();
            }

            async function saveContent() {
                const saveBtn = document.getElementById('saveContentBtn');
                try {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

                    const timeStr = `${document.getElementById('publishHour').value}:${document.getElementById('publishMinute').value} ${document.getElementById('publishPeriod').value}`;

                    // Pack metadata into notes field because of attribute limits
                    const metadata = {
                        userNotes: document.getElementById('contentNotes').value,
                        status: document.getElementById('contentStatus').value,
                        dayTasks: currentDayTasks
                    };

                    const payload = {
                        date: selectedDateStr,
                        notes: JSON.stringify(metadata),
                        images: JSON.stringify(uploadedImages),
                        platforms: JSON.stringify(selectedPlatforms),
                        publishTime: timeStr,
                        updatedAt: new Date().toISOString()
                    };

                    const existingDoc = contentStore[selectedDateStr];
                    if (existingDoc) {
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, existingDoc.id, payload);
                    } else {
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, ID.unique(), payload);
                    }

                    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­");
                    closeContentModal();
                    renderCalendar();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + e.message); } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                }
            }

            async function deleteContent() {
                if (!(await Swal.fire({ text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', icon: 'warning', showCancelButton: true })).isConfirmed) return;
                const existingDoc = contentStore[selectedDateStr];
                if (!existingDoc) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, existingDoc.id);
                    closeContentModal();
                    renderCalendar();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù"); }
            }

            // --- Global Tasks Logic ---
            async function fetchGlobalTasks() {
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, [
                        Query.orderDesc('createdAt')
                    ]);
                    const list = document.getElementById('globalTaskList');
                    let html = "";
                    response.documents.forEach(task => {
                        html += `
                            <div class="flex items-center gap-3 bg-gray-50/50 dark:bg-gray-900/30 p-4 rounded-2xl group border border-gray-50 dark:border-gray-800">
                                <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleGlobalTask('${task.$id}', ${task.done})" class="rounded text-primary focus:ring-primary">
                                <span class="text-xs font-bold flex-1 ${task.done ? 'line-through opacity-40' : 'text-secondary dark:text-white'}">${task.text}</span>
                                <button onclick="deleteGlobalTask('${task.$id}')" class="opacity-0 group-hover:opacity-100 text-red-400 transition-all"><span class="material-symbols-outlined text-xs">delete</span></button>
                            </div>
                        `;
                    });
                    list.innerHTML = html || '<div class="text-center py-10 opacity-30 text-xs font-black">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ©</div>';
                } catch (e) { console.error(e); }
            }

            async function addGlobalTask() {
                const { value: text } = await Swal.fire({
                    title: "Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                    text: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:",
                    input: 'text',
                    showCancelButton: true
                });
                if (!(text)) return;
                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, ID.unique(), {
                        text,
                        done: false,
                        createdAt: new Date().toISOString()
                    });
                    fetchGlobalTasks();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); }
            }

            async function toggleGlobalTask(id, currentDone) {
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, id, { done: !currentDone });
                    fetchGlobalTasks();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
            }

            async function deleteGlobalTask(id) {
                if (!(await Swal.fire({ text: 'Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ', icon: 'warning', showCancelButton: true })).isConfirmed) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, id);
                    fetchGlobalTasks();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù"); }
            }

            function renderReminders() {
                const reminderList = document.getElementById('upcomingReminders');
                if (!reminderList) return;

                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                const list = Object.values(contentStore)
                    .filter(c => {
                        const postDate = new Date(c.date);
                        postDate.setHours(23, 59, 59);
                        return postDate >= now && c.status !== 'published';
                    })
                    .sort((a, b) => {
                        // Custom sort for AM/PM format
                        const parseTime = (date, tStr) => {
                            const [time, period] = tStr.split(' ');
                            let [h, m] = time.split(':').map(Number);
                            if (period === 'PM' && h !== 12) h += 12;
                            if (period === 'AM' && h === 12) h = 0;
                            return new Date(`${date}T${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                        };
                        return parseTime(a.date, a.publishTime || '12:00 AM') - parseTime(b.date, b.publishTime || '12:00 AM');
                    })
                    .slice(0, 5);

                let html = "";
                list.forEach(c => {
                    const postDate = new Date(c.date);
                    const timeStrRaw = c.publishTime || '12:00 AM';
                    const [timePart, period] = timeStrRaw.split(' ');
                    let [h, m] = timePart.split(':').map(Number);
                    if (period === 'PM' && h !== 12) h += 12;
                    if (period === 'AM' && h === 12) h = 0;

                    const targetDateTime = new Date(`${c.date}T${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                    const diffMs = targetDateTime - now;

                    let countdownText = "";
                    if (diffMs > 0) {
                        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        if (diffHrs > 24) {
                            countdownText = `Ø¨Ø¹Ø¯ ${Math.floor(diffHrs / 24)} ÙŠÙˆÙ…`;
                        } else if (diffHrs > 0) {
                            countdownText = `Ø¨Ø§Ù‚ÙŠ ${diffHrs} Ø³Ø§Ø¹Ø© Ùˆ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
                        } else {
                            countdownText = `Ø¨Ø§Ù‚ÙŠ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
                        }
                    } else if (c.date === todayStr) {
                        countdownText = "Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±!";
                    }

                    // Platform Icons
                    let platformIcons = (c.platforms || []).map(p => {
                        const iconMap = { facebook: 'fab fa-facebook-f', instagram: 'fab fa-instagram', linkedin: 'fab fa-linkedin-in', whatsapp: 'fab fa-whatsapp' };
                        const colorMap = { facebook: '#1877f2', instagram: '#e1306c', linkedin: '#0077b5', whatsapp: '#25d366' };
                        return `<i class="${iconMap[p]} text-[10px]" style="color: ${colorMap[p]}"></i>`;
                    }).join(' ');

                    html += `
                        <div onclick="openContentModal('${c.date}')" class="group cursor-pointer bg-white dark:bg-gray-900/40 p-5 rounded-3xl border border-gray-100 dark:border-gray-800 hover:border-primary/30 hover:shadow-lg transition-all relative overflow-hidden">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="size-2 rounded-full ${c.status === 'ready' ? 'bg-primary animate-pulse' : 'bg-gray-300'}"></span>
                                    <span class="text-[10px] font-black text-secondary dark:text-white">${postDate.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' })}</span>
                                </div>
                                <div class="flex gap-1.5">${platformIcons}</div>
                            </div>
                            
                            <p class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-3 line-clamp-1">${c.notes || 'Ù…Ù†Ø´ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</p>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-gray-50 dark:border-gray-800/50">
                                <div class="flex items-center gap-1.5 text-primary">
                                    <span class="material-symbols-outlined text-sm">schedule</span>
                                    <span class="text-[10px] font-black">${c.publishTime || '--:--'}</span>
                                </div>
                                <span class="text-[9px] font-black text-gray-400 bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-lg">${countdownText}</span>
                            </div>
                        </div>
                    `;
                });
                reminderList.innerHTML = html || '<div class="text-center py-10 opacity-30 text-xs font-black">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§</div>';
            }

            // --- Excel Import Logic ---
            document.getElementById('importExcelInput').addEventListener('change', handleExcelUpload, false);

            async function handleExcelUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº!");
                        return;
                    }

                    if (!(await Swal.fire({ text: `Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${jsonData.length} Ø·Ø§Ù„Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`, icon: 'warning', showCancelButton: true })).isConfirmed) {
                        e.target.value = '';
                        return;
                    }

                    loadingData.style.display = 'block';
                    tableContainer.style.display = 'none';
                    const loadingTextEl = loadingData.querySelector('p');

                    let successCount = 0;
                    let failCount = 0;

                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const percentage = Math.round(((i + 1) / jsonData.length) * 100);
                        if (loadingTextEl) loadingTextEl.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ${percentage}%...`;

                        // Map Excel columns to DB fields (flexible mapping)
                        const name = row['Ø§Ù„Ø§Ø³Ù…'] || row['Name'] || row['name'];
                        const phone = row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['Phone'] || row['phone'] || row['Ø§Ù„Ù‡Ø§ØªÙ'];
                        const specialization = row['Ø§Ù„ØªØ®ØµØµ'] || row['Specialization'] || row['specialization'] || row['Ø§Ù„Ù…Ø¬Ø§Ù„'];
                        const plan = row['Ø§Ù„Ø¨Ø§Ù‚Ø©'] || row['Plan'] || row['plan'];

                        // Default values if missing
                        if (!name) {
                            // Skip rows without name (empty rows in Excel)
                            failCount++;
                            continue;
                        }

                        const nameStr = String(name).trim();

                        // Check & Delete Duplicates (Replace Logic)
                        try {
                            const existing = await databases.listDocuments(DATABASE_ID, COLLECTIONS.APPLICANTS, [
                                Query.equal('name', nameStr)
                            ]);
                            if (existing.documents.length > 0) {
                                for (const doc of existing.documents) {
                                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, doc.$id);
                                }
                            }
                        } catch (e) {
                            console.warn("Failed to check duplicate for " + nameStr);
                        }

                        const docData = {
                            name: nameStr,
                            phone: phone ? String(phone) : "",
                            specialization: specialization || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                            plan: plan || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                            status: "Ù†Ø´Ø·",
                            paymentStatus: "paid", // Default assumption for imported legacy data
                            timestamp: new Date().toISOString(),
                            teacherId: "",
                            teacherName: ""
                        };

                        // Optional: Check if payment status column exists
                        const payment = row['Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹'] || row['Payment'] || row['Payment Status'];
                        if (payment) {
                            if (payment.includes('ØªÙ…') || payment.toLowerCase() === 'paid') docData.paymentStatus = 'paid';
                            else docData.paymentStatus = 'unpaid';
                        } else {
                            docData.paymentStatus = 'unpaid'; // Changing default to unpaid if not specified to be safe? No, let's Stick to previous logic or safer 'unpaid'
                        }

                        // Check if status column exists
                        const status = row['Ø§Ù„Ø­Ø§Ù„Ø©'] || row['Status'];
                        if (status) docData.status = status;

                        try {
                            await databases.createDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, ID.unique(), docData);
                            successCount++;
                        } catch (err) {
                            console.error("Import error for row", row, err);
                            failCount++;
                        }
                    }

                    // Done
                    loadingData.style.display = 'none';
                    alert(`ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡!\nØªÙ… Ø¥Ø¶Ø§ÙØ©: ${successCount}\nÙØ´Ù„: ${failCount}`);
                    fetchApplicants(); // Refresh list
                    e.target.value = ''; // Reset input
                };
                reader.readAsArrayBuffer(file);
            }

            // --- Consultation Excel Import Logic ---
            document.getElementById('importConsultationExcelInput').addEventListener('change', handleConsultationExcelUpload, false);

            async function handleConsultationExcelUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº!");
                        return;
                    }

                    if (!(await Swal.fire({ text: `Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${jsonData.length} Ø·Ù„Ø¨ Ø§Ø³ØªØ´Ø§Ø±Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`, icon: 'warning', showCancelButton: true })).isConfirmed) {
                        e.target.value = '';
                        return;
                    }

                    loadingData.style.display = 'block';
                    const loadingTextEl = loadingData.querySelector('p');

                    let successCount = 0;
                    let failCount = 0;

                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const percentage = Math.round(((i + 1) / jsonData.length) * 100);
                        if (loadingTextEl) loadingTextEl.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ${percentage}%...`;

                        const name = row['Ø§Ù„Ø§Ø³Ù…'] || row['Name'] || row['name'];
                        const phone = row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['Phone'] || row['phone'] || row['Ø§Ù„Ù‡Ø§ØªÙ'];
                        const specialization = row['Ø§Ù„ØªØ®ØµØµ'] || row['Specialization'] || row['specialization'] || row['Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡'] || row['Ø§Ù„Ù…Ø¬Ø§Ù„'];

                        // Default values if missing
                        if (!name) {
                            // Skip rows without name (empty rows in Excel)
                            failCount++;
                            continue;
                        }

                        const nameStr = String(name).trim();

                        // Check & Delete Duplicates
                        try {
                            const existing = await databases.listDocuments(DATABASE_ID, COLLECTIONS.APPLICANTS, [
                                Query.equal('name', nameStr)
                            ]);
                            if (existing.documents.length > 0) {
                                for (const doc of existing.documents) {
                                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, doc.$id);
                                }
                            }
                        } catch (e) {
                            console.warn("Failed to check duplicate for " + nameStr);
                        }

                        const docData = {
                            name: nameStr,
                            phone: phone ? String(phone) : "",
                            specialization: specialization || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                            plan: "Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©",
                            status: "ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
                            paymentStatus: "unpaid",
                            timestamp: new Date().toISOString(),
                            teacherId: "",
                            teacherName: ""
                        };

                        try {
                            await databases.createDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, ID.unique(), docData);
                            successCount++;
                        } catch (err) {
                            console.error("Import error for row", row, err);
                            failCount++;
                        }
                    }

                    // Done
                    loadingData.style.display = 'none';
                    alert(`ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡!\nØªÙ… Ø¥Ø¶Ø§ÙØ©: ${successCount}\nÙØ´Ù„: ${failCount}`);
                    fetchApplicants(); // Refresh list
                    e.target.value = ''; // Reset input
                };
                reader.readAsArrayBuffer(file);
            }
            // --- Interns Management Logic ---
            let allInterns = [];

            async function fetchInterns() {
                const tableBody = document.getElementById('internsTableBody');
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 opacity-50">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.TRAINEES, [
                        Query.orderDesc('appliedAt')
                    ]);
                    allInterns = response.documents;
                    document.getElementById('internsCountBadge').textContent = `${allInterns.length} Ø·Ù„Ø¨`;
                    renderInterns(allInterns);

                    // Attach Filter Listeners
                    document.getElementById('internTrackFilter').onchange = filterInterns;
                    document.getElementById('internPackageFilter').onchange = filterInterns;
                    document.getElementById('internStatusFilter').onchange = filterInterns;
                    document.getElementById('internSearchInput').oninput = filterInterns;

                } catch (error) {
                    console.error('Error fetching interns:', error);
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-500 font-bold">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</td></tr>`;
                }
            }

            function filterInterns() {
                const track = document.getElementById('internTrackFilter').value;
                const pkg = document.getElementById('internPackageFilter').value;
                const status = document.getElementById('internStatusFilter').value;
                const search = document.getElementById('internSearchInput').value.toLowerCase();

                const filtered = allInterns.filter(intern => {
                    const matchTrack = !track || intern.track === track;
                    const matchPkg = !pkg || intern.package === pkg;
                    const matchStatus = !status || intern.status === status;
                    const matchSearch = !search ||
                        (intern.fullName && intern.fullName.toLowerCase().includes(search)) ||
                        (intern.email && intern.email.toLowerCase().includes(search));

                    return matchTrack && matchPkg && matchStatus && matchSearch;
                });

                renderInterns(filtered);
            }

            function renderInterns(internsList) {
                const tableBody = document.getElementById('internsTableBody');
                if (internsList.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 opacity-50">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
                    return;
                }

                tableBody.innerHTML = internsList.map(intern => {
                    const statusColors = {
                        'Pending': 'bg-orange-100 text-orange-600',
                        'Accepted': 'bg-green-100 text-green-600',
                        'Rejected': 'bg-red-100 text-red-600'
                    };
                    const statusClass = statusColors[intern.status] || 'bg-gray-100 text-gray-600';

                    return `
                        <tr class="hover:bg-primary/5 transition-colors group">
                            <td class="px-8 py-5">
                                <div>
                                    <p class="font-bold text-secondary dark:text-white">${intern.fullName}</p>
                                    <p class="text-xs text-gray-400 font-bold">${intern.email || ''}</p>
                                    <p class="text-[10px] text-gray-400 font-bold">${intern.mobile || ''}</p>
                                </div>
                            </td>
                            <td class="px-8 py-5">
                                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-lg text-xs font-bold">${intern.track}</span>
                                <p class="text-[10px] text-gray-400 mt-1 font-bold">${intern.level}</p>
                            </td>
                            <td class="px-8 py-5 font-bold text-sm text-primary">${intern.package}</td>
                            <td class="px-8 py-5">
                                <span class="${statusClass} px-3 py-1 rounded-lg text-xs font-black inline-flex items-center gap-1">
                                    ${intern.status === 'Accepted' ? '<span class="material-symbols-outlined text-[10px]">check</span>' : ''}
                                    ${intern.status}
                                </span>
                            </td>
                            <td class="px-8 py-5 text-xs font-bold text-gray-500">
                                ${new Date(intern.appliedAt).toLocaleDateString('ar-EG')}
                            </td>
                            <td class="px-8 py-5 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button onclick="viewInternDetails('${intern.$id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                        <span class="material-symbols-outlined text-sm">visibility</span>
                                    </button>
                                    ${intern.status === 'Pending' ? `
                                        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„Ø±ÙØ¶ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙ‚Ø· -->
                                        <button onclick="updateInternStatus('${intern.$id}', 'Accepted')" class="btn-icon btn-icon-success" title="Ù‚Ø¨ÙˆÙ„">
                                            <span class="material-symbols-outlined text-sm">check</span>
                                        </button>
                                        <button onclick="updateInternStatus('${intern.$id}', 'Rejected')" class="btn-icon btn-icon-danger" title="Ø±ÙØ¶">
                                            <span class="material-symbols-outlined text-sm">close</span>
                                        </button>
                                    ` : ''}
                                    <!-- Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…ØªØ¯Ø±Ø¨ -->
                                    <button onclick="deleteIntern('${intern.$id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù Ø§Ù„Ù…ØªØ¯Ø±Ø¨">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async function updateInternStatus(id, newStatus) {
                if (!(await Swal.fire({ text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${newStatus}ØŸ`, icon: 'warning', showCancelButton: true })).isConfirmed) return;

                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.TRAINEES, id, {
                        status: newStatus
                    });

                    // Update local list and re-render
                    const intern = allInterns.find(i => i.$id === id);
                    if (intern) intern.status = newStatus;
                    filterInterns(); // Re-render with existing filters

                    // Optional: If Accepted, maybe trigger a notification or similar logic (as per request "shows training tab for user")
                    // This "showing tab" logic would be on the user-side code checking this status.

                } catch (error) {
                    alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ' + error.message);
                }
            }

            async function deleteIntern(id) {
                if (!(await Swal.fire({ text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ', icon: 'error', showCancelButton: true })).isConfirmed) return;

                try {
                    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.TRAINEES, id);

                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                        text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¨Ù†Ø¬Ø§Ø­.'
                    });

                    fetchInterns(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                } catch (error) {
                    console.error('Error deleting intern:', error);
                    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', text: error.message });
                }
            }

            // --- Manual Trainee Add Logic ---
            function openTraineeModal() {
                document.getElementById('traineeModal').classList.remove('hidden');
            }
            function closeTraineeModal() {
                document.getElementById('traineeModal').classList.add('hidden');
                document.getElementById('manualTraineeForm').reset();
            }

            document.getElementById('manualTraineeForm').onsubmit = async (e) => {
                e.preventDefault();

                const formData = {
                    fullName: document.getElementById('mFullName').value,
                    email: document.getElementById('mEmail').value,
                    mobile: document.getElementById('mMobile').value,
                    track: document.getElementById('mTrack').value,
                    level: document.getElementById('mLevel').value,
                    package: document.getElementById('mPackage').value,
                    status: document.getElementById('mStatus').value,
                    appliedAt: new Date().toISOString(),
                    // Default values for fields not in manual form but required schema
                    githubLink: 'https://github.com/manual',
                    cvLink: '',
                    reason: 'Added manually by admin'
                };

                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.TRAINEES, ID.unique(), formData);
                    closeTraineeModal();
                    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                    fetchInterns();
                } catch (err) {
                    console.error(err);
                    alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨: ' + err.message);
                }
            };

            // --- View Intern Details ---
            function viewInternDetails(id) {
                const intern = allInterns.find(i => i.$id === id);
                if (!intern) {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¯Ø±Ø¨');
                    return;
                }

                const statusEmoji = {
                    'Pending': 'â³',
                    'Accepted': 'âœ…',
                    'Rejected': 'âŒ'
                };

                const statusText = {
                    'Pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                    'Accepted': 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„',
                    'Rejected': 'Ù…Ø±ÙÙˆØ¶'
                };

                Swal.fire({
                    title: `ğŸ“‹ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨`,
                    html: `
                        <div class="text-right space-y-4 text-secondary dark:text-white pb-4" dir="rtl">
                            <!-- Basic Header Card -->
                            <div class="bg-primary/5 dark:bg-primary/10 p-6 rounded-[2rem] border border-primary/10 text-center">
                                <div class="size-20 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white dark:border-gray-800 shadow-sm">
                                    <span class="material-symbols-outlined text-4xl text-primary font-black">person</span>
                                </div>
                                <h4 class="text-xl font-black mb-1">${intern.fullName || intern.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</h4>
                                <p class="text-xs font-bold text-gray-500 flex items-center justify-center gap-1">
                                    <span class="material-symbols-outlined text-sm">mail</span>
                                    ${intern.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'}
                                </p>
                            </div>
                            
                            <!-- Grid Details -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl border border-gray-100 dark:border-gray-700">
                                    <p class="text-[10px] text-gray-400 font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</p>
                                    <p class="font-bold text-sm" dir="ltr">${intern.mobile || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl border border-gray-100 dark:border-gray-700">
                                    <p class="text-[10px] text-gray-400 font-bold mb-1">Ø§Ù„ØªØ®ØµØµ (Track)</p>
                                    <p class="font-bold text-sm text-primary">${intern.track || '--'}</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-2xl border border-blue-100 dark:border-blue-900/20">
                                    <p class="text-[10px] text-blue-600 dark:text-blue-400 font-bold mb-1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</p>
                                    <p class="font-black text-blue-700 dark:text-blue-300">${intern.level || '--'}</p>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/10 p-4 rounded-2xl border border-purple-100 dark:border-purple-900/20">
                                    <p class="text-[10px] text-purple-600 dark:text-purple-400 font-bold mb-1">Ø§Ù„Ø¨Ø§Ù‚Ø©</p>
                                    <p class="font-black text-purple-700 dark:text-purple-300">${intern.package || '--'}</p>
                                </div>
                            </div>

                            <!-- Case Specific info -->
                            <div class="bg-orange-50 dark:bg-orange-900/10 p-4 rounded-2xl border border-orange-100 dark:border-orange-900/20 flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] text-orange-600 dark:text-orange-400 font-bold mb-0.5">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                                    <p class="font-black text-sm text-orange-700 dark:text-orange-300">${statusEmoji[intern.status] || ''} ${statusText[intern.status] || intern.status || '--'}</p>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] text-orange-600 dark:text-orange-400 font-bold mb-0.5 text-left">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</p>
                                    <p class="font-bold text-[10px]">${intern.appliedAt ? new Date(intern.appliedAt).toLocaleDateString('ar-EG') : '--'}</p>
                                </div>
                            </div>

                            <!-- Links -->
                            <div class="grid grid-cols-2 gap-3">
                                <a href="${intern.githubLink || '#'}" target="_blank" class="flex flex-col gap-1 p-4 bg-gray-900 text-white rounded-2xl hover:bg-black transition-colors">
                                    <span class="material-symbols-outlined text-lg">link</span>
                                    <span class="text-[10px] font-bold opacity-70">GitHub Profile</span>
                                    <span class="text-xs font-black truncate">${intern.githubLink ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                                </a>
                                <div class="flex flex-col gap-1 p-4 bg-green-600 text-white rounded-2xl opacity-50 cursor-not-allowed">
                                    <span class="material-symbols-outlined text-lg">description</span>
                                    <span class="text-[10px] font-bold opacity-70">Resume / CV</span>
                                    <span class="text-xs font-black">${intern.cvLink ? 'ØªØ­Ù…ÙŠÙ„' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù'}</span>
                                </div>
                            </div>

                            <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-2xl border border-gray-100 dark:border-gray-700">
                                <p class="text-[10px] text-gray-400 font-black mb-2 uppercase tracking-widest">Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</p>
                                <p class="text-xs font-bold leading-relaxed opacity-80">${intern.reason || 'Ù„Ù… ÙŠØªÙ… Ø°ÙƒØ± Ø³Ø¨Ø¨ Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…'}</p>
                            </div>
                        </div>
                    `,
                    width: '500px',
                    confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚'
                });
            }

            // --- Excel Export/Import for Interns ---
            function exportInternsToExcel() {
                if (allInterns.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
                        text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù„Ù„ØªØµØ¯ÙŠØ±',
                        confirmButtonColor: '#13b6ec'
                    });
                    return;
                }

                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
                const data = allInterns.map(intern => ({
                    'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„': intern.fullName,
                    'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': intern.email,
                    'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': intern.mobile || '',
                    'Ø§Ù„ØªØ±Ø§Ùƒ': intern.track,
                    'Ø§Ù„Ù…Ø³ØªÙˆÙ‰': intern.level,
                    'Ø§Ù„Ø¨Ø§Ù‚Ø©': intern.package,
                    'Ø§Ù„Ø­Ø§Ù„Ø©': intern.status,
                    'GitHub': intern.githubLink,
                    'CV': intern.cvLink || '',
                    'Ø³Ø¨Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…': intern.reason || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…': new Date(intern.appliedAt).toLocaleDateString('ar-EG')
                }));

                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†');

                // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                const fileName = `trainees_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                Swal.fire({
                    icon: 'success',
                    title: 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!',
                    text: `ØªÙ… ØªØµØ¯ÙŠØ± ${allInterns.length} Ù…ØªØ¯Ø±Ø¨`,
                    confirmButtonColor: '#13b6ec'
                });
            }

            async function importInternsFromExcel(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet);

                        if (rows.length === 0) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Ù…Ù„Ù ÙØ§Ø±Øº',
                                text: 'Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª',
                                confirmButtonText: 'Ù†Ø¹Ù…'
                            });
                            return;
                        }

                        let successCount = 0;
                        let failCount = 0;

                        // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                        Swal.fire({
                            title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...',
                            html: `<div class="text-lg font-bold">ØªÙ…: <span id="importProgress">0</span> / ${rows.length}</div>`,
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];

                            const formData = {
                                fullName: row['Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„'] || row['fullName'] || '',
                                email: row['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'] || row['email'] || '',
                                mobile: row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['mobile'] || '',
                                track: row['Ø§Ù„ØªØ±Ø§Ùƒ'] || row['track'] || 'Backend',
                                level: row['Ø§Ù„Ù…Ø³ØªÙˆÙ‰'] || row['level'] || 'Beginner',
                                package: row['Ø§Ù„Ø¨Ø§Ù‚Ø©'] || row['package'] || 'Starter',
                                status: row['Ø§Ù„Ø­Ø§Ù„Ø©'] || row['status'] || 'Pending',
                                githubLink: row['GitHub'] || row['githubLink'] || 'https://github.com',
                                cvLink: row['CV'] || row['cvLink'] || '',
                                reason: row['Ø³Ø¨Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…'] || row['reason'] || 'Imported from Excel',
                                appliedAt: new Date().toISOString()
                            };

                            // Ø­Ø°Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§Ø±ØºØ©
                            if (!formData.mobile) delete formData.mobile;
                            if (!formData.cvLink) delete formData.cvLink;

                            try {
                                await databases.createDocument(DATABASE_ID, COLLECTIONS.TRAINEES, ID.unique(), formData);
                                successCount++;
                            } catch (err) {
                                console.error('Import error for row', row, err);
                                failCount++;
                            }

                            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                            document.getElementById('importProgress').textContent = i + 1;
                        }

                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        await fetchInterns();

                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!',
                            html: `
                                <div class="text-right" dir="rtl">
                                    <p class="text-green-600 font-bold">âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ©: ${successCount}</p>
                                    ${failCount > 0 ? `<p class="text-red-600 font-bold">âŒ ÙØ´Ù„: ${failCount}</p>` : ''}
                                </div>
                            `,
                            confirmButtonColor: '#13b6ec'
                        });

                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                            text: error.message,
                            confirmButtonColor: '#13b6ec'
                        });
                    }

                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† input
                    event.target.value = '';
                };

                reader.readAsArrayBuffer(file);
            }
            function openInternConversionModal(id, name, source, track = '') {
                document.getElementById('icApplicantId').value = id;
                document.getElementById('icApplicantName').textContent = name;
                document.getElementById('icSourceCollection').value = source;
                if (track) {
                    document.getElementById('icTrack').value = track;
                }
                document.getElementById('internConversionModal').classList.remove('hidden');
            }

            function closeInternConversionModal() {
                document.getElementById('internConversionModal').classList.add('hidden');
                document.getElementById('internConversionForm').reset();
            }

            document.getElementById('internConversionForm').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('icApplicantId').value;
                const source = document.getElementById('icSourceCollection').value;

                // Find data from source
                let applicantData = null;
                if (source === 'APPLICANTS') {
                    applicantData = applicants.find(a => a.id === id);
                }

                if (!applicantData) {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');
                    return;
                }

                const formData = {
                    fullName: applicantData.name || 'Ù…Ø¬Ù‡ÙˆÙ„',
                    email: applicantData.phone ? `${applicantData.phone}@bousla.com` : 'noemail@bousla.com', // Placeholder if no email
                    mobile: applicantData.phone || '',
                    track: document.getElementById('icTrack').value,
                    level: document.getElementById('icLevel').value,
                    package: document.getElementById('icPackage').value,
                    status: 'Accepted',
                    appliedAt: new Date().toISOString(),
                    githubLink: 'https://github.com/converted',
                    cvLink: '',
                    reason: `Converted from ${source === 'APPLICANTS' ? (applicantData.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©' ? 'Free Consultation' : 'Regular Student') : source}`
                };

                // Check if email exists in applicant data (some might have it)
                if (applicantData.email) formData.email = applicantData.email;

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù€ Validation ÙÙŠ Appwrite (Ø®Ø§ØµØ© Ø§Ù„Ù€ URL)
                if (!formData.cvLink) delete formData.cvLink;
                if (!formData.mobile) delete formData.mobile;

                try {
                    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                    // 1. Create trainee document
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.TRAINEES, ID.unique(), formData);

                    // 2. Delete from original collection
                    if (source === 'APPLICANTS') {
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id);
                        applicants = applicants.filter(a => a.id !== id);
                        if (typeof filter === 'function') filter();
                        if (typeof renderConsultations === 'function') renderConsultations();
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!',
                        text: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒÙ…ØªØ¯Ø±Ø¨ ÙˆØ­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†',
                        confirmButtonColor: '#13b6ec'
                    });

                    closeInternConversionModal();
                    if (typeof closeModal === 'function') closeModal();
                    if (typeof fetchInterns === 'function') fetchInterns();

                } catch (err) {
                    console.error(err);
                    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„', text: err.message });
                }
            };
        </script>
        <!-- BouslaAlert UI -->
        <div id="bouslaAlert"
            class="fixed inset-0 z-[1000] flex items-center justify-center p-4 backdrop-blur-md bg-secondary/30 hidden">
            <div
                class="alert-content bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 lg:p-12 max-w-[90%] md:max-w-md w-full shadow-2xl border border-white/20 text-center relative overflow-hidden transition-all duration-300 scale-90 opacity-0 transform-gpu">
                <!-- Progress Line for Auto-close (optional) -->
                <div id="alertProgress"
                    class="absolute bottom-0 right-0 h-1.5 bg-primary transition-all duration-100 ease-linear"
                    style="width: 0%"></div>

                <div id="alertIconContainer"
                    class="size-20 bg-primary/10 rounded-3xl flex items-center justify-center text-primary mx-auto mb-6">
                    <span id="alertIcon" class="material-symbols-outlined text-4xl">info</span>
                </div>

                <h3 id="alertTitle" class="text-xl font-black text-secondary dark:text-white mb-2"></h3>
                <div id="alertText"
                    class="font-bold text-gray-400 leading-relaxed mb-8 overflow-y-auto max-h-[60vh] custom-scrollbar text-sm">
                </div>

                <input id="alertInput" type="text"
                    class="w-full px-6 py-4 bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl text-center font-bold mb-8 outline-none focus:ring-2 focus:ring-primary/20 transition-all hidden" />

                <div id="alertActions" class="flex gap-3">
                    <button id="alertCancelBtn" class="btn-secondary flex-1 py-4 hidden">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="alertConfirmBtn" class="btn-primary flex-1 py-4">Ù…ÙˆØ§ÙÙ‚</button>
                </div>
            </div>
        </div>

        <script>
            const BouslaAlert = {
                timer: null,
                fire: function (options) {
                    const el = document.getElementById('bouslaAlert');
                    const title = document.getElementById('alertTitle');
                    const text = document.getElementById('alertText');
                    const icon = document.getElementById('alertIcon');
                    const iconContainer = document.getElementById('alertIconContainer');
                    const confirmBtn = document.getElementById('alertConfirmBtn');
                    const cancelBtn = document.getElementById('alertCancelBtn');
                    const inputEl = document.getElementById('alertInput');
                    const progress = document.getElementById('alertProgress');
                    const actions = document.getElementById('alertActions');

                    // Reset
                    clearTimeout(this.timer);
                    progress.style.width = '0%';
                    inputEl.classList.add('hidden');
                    inputEl.value = '';
                    el.classList.remove('hidden');
                    // Force a reflow to ensure transitions work
                    el.offsetHeight;
                    el.classList.add('active');

                    // Set Content
                    title.textContent = options.title || '';
                    if (options.html) {
                        text.innerHTML = options.html;
                    } else {
                        text.textContent = options.text || '';
                    }

                    // Width handling
                    const contentEl = el.querySelector('.alert-content');
                    contentEl.style.maxWidth = options.width || '';
                    if (!options.width) {
                        contentEl.classList.add('md:max-w-md');
                    } else {
                        contentEl.classList.remove('md:max-w-md');
                    }

                    // Input
                    if (options.input) {
                        inputEl.classList.remove('hidden');
                        inputEl.type = options.input === 'password' ? 'password' : 'text';
                        inputEl.value = options.inputValue || '';
                        inputEl.placeholder = options.inputPlaceholder || '';
                    }

                    // Icon Styling
                    const type = options.icon || 'info';
                    iconContainer.className = 'size-20 rounded-3xl flex items-center justify-center mx-auto mb-6 ';
                    if (type === 'success') {
                        icon.textContent = 'check_circle';
                        iconContainer.classList.add('bg-green-50', 'text-green-500');
                    } else if (type === 'error') {
                        icon.textContent = 'error';
                        iconContainer.classList.add('bg-red-50', 'text-red-500');
                    } else if (type === 'warning') {
                        icon.textContent = 'warning';
                        iconContainer.classList.add('bg-orange-50', 'text-orange-500');
                    } else {
                        icon.textContent = 'info';
                        iconContainer.classList.add('bg-primary/10', 'text-primary');
                    }

                    // Loading State
                    if (options.showLoading) {
                        icon.textContent = 'sync';
                        icon.classList.add('alert-loading-icon');
                        actions.style.display = 'none';
                    } else {
                        icon.classList.remove('alert-loading-icon');
                        actions.style.display = 'flex';
                    }

                    // Buttons
                    confirmBtn.textContent = options.confirmButtonText || 'Ù…ÙˆØ§ÙÙ‚';
                    confirmBtn.onclick = () => {
                        this.close(true);
                        if (options.onConfirm) options.onConfirm();
                    };

                    if (options.showCancelButton) {
                        cancelBtn.classList.remove('hidden');
                        cancelBtn.textContent = options.cancelButtonText || 'Ø¥Ù„ØºØ§Ø¡';
                        cancelBtn.onclick = () => {
                            this.close(false);
                            if (options.onCancel) options.onCancel();
                        };
                    } else {
                        cancelBtn.classList.add('hidden');
                    }

                    // didOpen hook
                    if (options.didOpen && typeof options.didOpen === 'function') {
                        setTimeout(() => options.didOpen(), 100);
                    }

                    // Auto Close
                    if (options.timer) {
                        let start = Date.now();
                        const updateProgress = () => {
                            const elapsed = Date.now() - start;
                            const p = (elapsed / options.timer) * 100;
                            progress.style.width = Math.min(p, 100) + '%';
                            if (elapsed < options.timer) requestAnimationFrame(updateProgress);
                        };
                        requestAnimationFrame(updateProgress);

                        this.timer = setTimeout(() => {
                            this.close(false);
                        }, options.timer);
                    }

                    return new Promise(resolve => {
                        this.resolve = resolve;
                    });
                },
                showLoading: function () {
                    // Handled by calling fire with showLoading: true
                },
                close: function (confirmed = true) {
                    const el = document.getElementById('bouslaAlert');
                    const inputEl = document.getElementById('alertInput');
                    const value = inputEl.value;

                    el.classList.remove('active');
                    setTimeout(() => {
                        el.classList.add('hidden');
                        if (this.resolve) this.resolve({ isConfirmed: confirmed, value: value });
                    }, 400);
                }
            };

            // Global access for scripts that use Swal.fire
            window.Swal = {
                fire: (opts) => BouslaAlert.fire(opts),
                showLoading: () => {
                    // Update current alert to loading
                    const icon = document.getElementById('alertIcon');
                    icon.textContent = 'sync';
                    icon.classList.add('alert-loading-icon');
                    document.getElementById('alertActions').style.display = 'none';
                },
                close: () => BouslaAlert.close()
            };

            // Redirect native alert/confirm to BouslaAlert
            window.alert = (msg) => BouslaAlert.fire({ text: msg, icon: 'info' });

            // Note: window.confirm replacement is async, so it won't work for synchronous code.
            const nativeConfirm = window.confirm;
            window.confirm = (msg) => {
                console.warn(' Native confirm() called. Use await Swal.fire instead for best experience.');
                return nativeConfirm(msg);
            };
        </script>
        <script>


            // --- Course & Subscriber Management ---

            let currentViewingCourseId = null;

            async function fetchCourses() {
                const grid = document.getElementById('courses-grid');
                if (!grid) return;
                grid.innerHTML = '<div class="col-span-full text-center py-10 opacity-50">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª...</div>';

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSES);
                    if (response.documents.length === 0) {
                        grid.innerHTML = '<div class="col-span-full text-center py-10 opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                        return;
                    }

                    grid.innerHTML = response.documents.map(course => {
                        const thumbUrl = course.thumbnailId ? storage.getFileView(BUCKETS.COURSE_THUMBNAILS, course.thumbnailId) : '../assets/images/logo.jpg';
                        return `
                            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden group">
                                <div class="aspect-video relative overflow-hidden">
                                    <img src="${thumbUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                        <button onclick="editCourse('${course.$id}')" class="size-10 bg-white rounded-full flex items-center justify-center text-primary shadow-lg" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button onclick="handleCourseDelete('${course.$id}')" class="size-10 bg-white rounded-full flex items-center justify-center text-red-500 shadow-lg" title="Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <h3 class="text-lg font-black text-secondary dark:text-white mb-2">${course.title}</h3>
                                    <p class="text-xs font-bold text-gray-400 line-clamp-2">${course.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                                    <div class="mt-4 pt-4 border-t border-gray-50 dark:border-gray-700 flex items-center justify-between">
                                        <button onclick="viewCourseVideos('${course.$id}')" class="text-primary text-xs font-black flex items-center gap-1">
                                            Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
                                            <span class="material-symbols-outlined text-sm">arrow_forward</span>
                                        </button>
                                        <button onclick="openVideoModal('${course.$id}')" class="text-green-500 text-xs font-black flex items-center gap-1">
                                            Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ
                                            <span class="material-symbols-outlined text-sm">add</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (e) {
                    grid.innerHTML = `<div class="col-span-full text-center py-10 text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£: ${e.message}</div>`;
                }
            }

            async function editCourse(id) {
                try {
                    const course = await databases.getDocument(DATABASE_ID, COLLECTIONS.COURSES, id);
                    document.getElementById('courseId').value = course.$id;
                    document.getElementById('courseTitle').value = course.title;
                    document.getElementById('courseDescription').value = course.description || '';
                    document.getElementById('courseOldPrice').value = course.oldPrice || '';
                    document.getElementById('coursePrice').value = course.price || '';
                    document.getElementById('courseIsFree').value = course.isFree ? 'true' : 'false';
                    document.getElementById('courseModal').querySelector('h2').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³';
                    document.getElementById('courseModal').classList.remove('hidden');
                } catch (e) { alert(e.message); }
            }

            function openCourseModal() {
                document.getElementById('courseForm').reset();
                document.getElementById('courseId').value = '';
                document.getElementById('courseModal').querySelector('h2').textContent = 'Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯';
                document.getElementById('courseModal').classList.remove('hidden');
            }

            function closeCourseModal() {
                document.getElementById('courseModal').classList.add('hidden');
            }

            document.getElementById('courseForm').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('courseId').value;
                const title = document.getElementById('courseTitle').value;
                const description = document.getElementById('courseDescription').value;
                const oldPrice = document.getElementById('courseOldPrice').value;
                const price = document.getElementById('coursePrice').value;
                const isFree = document.getElementById('courseIsFree').value === 'true';
                const thumbFile = document.getElementById('courseThumbnail').files[0];

                try {
                    let data = { title, description, oldPrice, price, isFree };
                    if (thumbFile) {
                        const uploaded = await storage.createFile(BUCKETS.COURSE_THUMBNAILS, ID.unique(), thumbFile);
                        data.thumbnailId = uploaded.$id;
                    }

                    if (id) {
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.COURSES, id, data);
                        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.COURSES, ID.unique(), data);
                        alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
                    }
                    closeCourseModal();
                    fetchCourses();
                } catch (e) {
                    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + e.message);
                }
            };

            async function handleCourseDelete(id) {
                const result = await Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª',
                    text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ÙÙŠÙ‡ØŒ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                });

                if (result.isConfirmed) {
                    try {
                        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                        // 1. Get Course to find thumbnail
                        const course = await databases.getDocument(DATABASE_ID, COLLECTIONS.COURSES, id);

                        // 2. Find and delete all associated videos + their files
                        const vids = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, [
                            Query.equal('courseId', id)
                        ]);

                        for (const vid of vids.documents) {
                            if (vid.videoId) {
                                try { await storage.deleteFile(BUCKETS.COURSE_VIDEOS, vid.videoId); } catch (e) { }
                            }
                            await databases.deleteDocument(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, vid.$id);
                        }

                        // 3. Delete course thumbnail
                        if (course.thumbnailId) {
                            try { await storage.deleteFile(BUCKETS.COURSE_THUMBNAILS, course.thumbnailId); } catch (e) { }
                        }

                        // 4. Delete course doc
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.COURSES, id);

                        Swal.close();
                        fetchCourses();
                        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³ ÙˆØ¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
                    } catch (e) {
                        Swal.close();
                        alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + e.message);
                    }
                }
            }

            // Video functions
            function openVideoModal(courseId, videoId = '') {
                document.getElementById('v_courseId').value = courseId;
                document.getElementById('v_videoId').value = videoId;
                document.getElementById('videoForm').reset();
                const modalTitle = videoId ? 'ØªØ¹Ø¯ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ' : 'Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ÙƒÙˆØ±Ø³';
                document.getElementById('videoModalTitle').textContent = modalTitle;

                if (videoId) {
                    databases.getDocument(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, videoId)
                        .then(v => {
                            document.getElementById('videoTitle').value = v.title;
                        });
                }

                document.getElementById('videoModal').classList.remove('hidden');
            }

            function closeVideoModal() {
                document.getElementById('videoModal').classList.add('hidden');
            }

            document.getElementById('videoForm').onsubmit = async (e) => {
                e.preventDefault();
                const courseId = document.getElementById('v_courseId').value;
                const videoId = document.getElementById('v_videoId').value;
                const title = document.getElementById('videoTitle').value;
                const file = document.getElementById('videoFile').files[0];

                if (!file && !videoId) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ');
                    return;
                }

                const btnText = document.getElementById('video-upload-text');
                const spinner = document.getElementById('video-upload-spinner');
                const progressContainer = document.getElementById('video-progress-container');
                const progressBar = document.getElementById('video-progress-bar');
                const progressPercent = document.getElementById('video-progress-percent');

                btnText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                spinner.classList.remove('hidden');

                try {
                    let data = { courseId, title };

                    if (file) {
                        progressContainer.classList.remove('hidden');
                        const uploaded = await storage.createFile(BUCKETS.COURSE_VIDEOS, ID.unique(), file, [], (progress) => {
                            const p = Math.round(progress.progress);
                            progressBar.style.width = p + '%';
                            progressPercent.textContent = p + '%';
                        });
                        data.videoId = uploaded.$id;
                    }

                    if (videoId) {
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, videoId, data);
                        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        data.order = 0;
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, ID.unique(), data);
                        alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­');
                    }

                    closeVideoModal();
                    if (currentViewingCourseId) viewCourseVideos(currentViewingCourseId);
                } catch (e) {
                    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + e.message);
                } finally {
                    btnText.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
                    spinner.classList.add('hidden');
                    progressContainer.classList.add('hidden');
                }
            };

            async function viewCourseVideos(courseId) {
                currentViewingCourseId = courseId;
                const container = document.getElementById('videos-list-container');
                const modal = document.getElementById('courseVideosModal');

                container.innerHTML = '<div class="text-center py-10 opacity-50">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª...</div>';
                modal.classList.remove('hidden');

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, [
                        Query.equal('courseId', courseId),
                        Query.orderAsc('order')
                    ]);

                    if (response.documents.length === 0) {
                        container.innerHTML = '<div class="text-center py-10 opacity-50 italic">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³</div>';
                        return;
                    }

                    container.innerHTML = response.documents.map(video => `
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl flex items-center justify-between gap-4 group">
                            <div class="flex items-center gap-4">
                                <div class="size-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">play_circle</span>
                                </div>
                                <h4 class="font-bold text-secondary dark:text-white">${video.title}</h4>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openVideoModal('${courseId}', '${video.$id}')" class="btn-icon btn-icon-primary">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button onclick="deleteVideo('${video.$id}')" class="btn-icon btn-icon-danger">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    container.innerHTML = `<div class="text-center py-10 text-red-500">${e.message}</div>`;
                }
            }

            function closeCourseVideosModal() {
                document.getElementById('courseVideosModal').classList.add('hidden');
                currentViewingCourseId = null;
            }

            async function deleteVideo(id) {
                const result = await Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ù…Ù„Ù',
                    text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ù…Ø§',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                });

                if (result.isConfirmed) {
                    try {
                        // 1. Get video doc to find storage ID
                        const vid = await databases.getDocument(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, id);

                        // 2. Delete from storage if exists
                        if (vid.videoId) {
                            try {
                                await storage.deleteFile(BUCKETS.COURSE_VIDEOS, vid.videoId);
                            } catch (e) {
                                console.warn('Could not delete storage file, it might be already gone.', e);
                            }
                        }

                        // 3. Delete from DB
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.COURSE_VIDEOS, id);

                        if (currentViewingCourseId) viewCourseVideos(currentViewingCourseId);
                        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                    } catch (e) { alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + e.message); }
                }
            }

            let allSubscribers = [];
            let courseMap = {};

            async function fetchSubscribers() {
                const tbody = document.getElementById('subscribersTableBody');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 opacity-30">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...</td></tr>';

                try {
                    // Fetch all courses first to Map IDs to Titles
                    const coursesRes = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSES);
                    courseMap = {};
                    coursesRes.documents.forEach(c => courseMap[c.$id] = c.title);

                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, [
                        Query.orderDesc('$createdAt'),
                        Query.limit(100) // Increase limit or implement proper pagination if needed
                    ]);

                    allSubscribers = response.documents;
                    renderSubscribers(allSubscribers);

                    // Attach Filter Listeners
                    document.getElementById('subSearchInput').oninput = filterSubscribers;
                    document.getElementById('subStatusFilter').onchange = filterSubscribers;

                } catch (e) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£: ${e.message}</td></tr>`;
                }
            }

            function filterSubscribers() {
                const search = document.getElementById('subSearchInput').value.toLowerCase();
                const status = document.getElementById('subStatusFilter').value;

                const filtered = allSubscribers.filter(sub => {
                    const matchSearch = !search ||
                        (sub.name && sub.name.toLowerCase().includes(search)) ||
                        (sub.phone && sub.phone.includes(search));

                    const matchStatus = !status || sub.paymentStatus === status;

                    return matchSearch && matchStatus;
                });

                renderSubscribers(filtered);
            }

            function renderSubscribers(list) {
                const tbody = document.getElementById('subscribersTableBody');

                // Update stats counters based on *current filtered list* or *total list*? 
                // Usually stats show total. Let's keep stats based on TOTAL fetched.
                const subTotal = allSubscribers.length;
                const subPaid = allSubscribers.filter(s => s.paymentStatus === 'paid').length;
                const subUnpaid = subTotal - subPaid;

                if (document.getElementById('totalSubscribersCount')) document.getElementById('totalSubscribersCount').textContent = subTotal;
                if (document.getElementById('paidSubscribersCount')) document.getElementById('paidSubscribersCount').textContent = subPaid;
                if (document.getElementById('unpaidSubscribersCount')) document.getElementById('unpaidSubscribersCount').textContent = subUnpaid;


                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 opacity-30 font-bold text-lg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</td></tr>';
                    return;
                }

                tbody.innerHTML = list.map(sub => {
                    const statusColors = {
                        'pending': 'bg-orange-100 text-orange-600',
                        'paid': 'bg-green-100 text-green-600',
                        'blocked': 'bg-red-100 text-red-600',
                        'unpaid': 'bg-red-100 text-red-600'
                    };
                    const statusText = {
                        'pending': 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹',
                        'paid': 'ØªÙ… Ø§Ù„Ø¯ÙØ¹',
                        'blocked': 'Ù…Ø­Ø¸ÙˆØ±',
                        'unpaid': 'Ù„Ù… ÙŠØ¯ÙØ¹'
                    };
                    const statusClass = statusColors[sub.paymentStatus] || 'bg-gray-100 text-gray-600';
                    const statusLabel = statusText[sub.paymentStatus] || sub.paymentStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                    // Format courses list
                    const subCourses = sub.courses || [];
                    const coursesSummary = subCourses.length > 0
                        ? subCourses.map(id => courseMap[id] || 'ÙƒÙˆØ±Ø³ Ù…Ø­Ø°ÙˆÙ').join(', ')
                        : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                            <td class="px-8 py-5">
                                <div class="font-bold text-secondary dark:text-white">${sub.name}</div>
                                <div class="text-[10px] text-gray-400 font-bold">${new Date(sub.$createdAt).toLocaleDateString('ar-EG')}</div>
                            </td>
                            <td class="px-8 py-5 font-bold text-primary" dir="ltr">${sub.phone}</td>
                            <td class="px-8 py-5">
                                <span class="px-3 py-1 rounded-full text-[10px] font-black ${statusClass}">
                                    ${statusLabel}
                                </span>
                            </td>
                            <td class="px-8 py-5">
                                <div class="text-[10px] font-bold text-gray-500 max-w-[150px] truncate" title="${coursesSummary}">
                                    ${coursesSummary}
                                </div>
                                <div class="text-[9px] text-primary font-black mt-1">${subCourses.length} ÙƒÙˆØ±Ø³</div>
                            </td>
                            <td class="px-8 py-5 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button onclick="editSubscriber('${sub.$id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„">
                                        <span class="material-symbols-outlined">visibility</span>
                                    </button>
                                    <button onclick="deleteSubscriber('${sub.$id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                        <span class="material-symbols-outlined">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async function editSubscriber(id) {
                try {
                    const sub = await databases.getDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, id);
                    document.getElementById('subId').value = sub.$id;
                    document.getElementById('subName').value = sub.name;
                    document.getElementById('subPhone').value = sub.phone;
                    document.getElementById('subPassword').value = sub.password || '';
                    document.getElementById('subPaymentStatus').value = sub.paymentStatus || 'pending';

                    document.getElementById('subModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ';

                    // Device Reset UI
                    const resetContainer = document.getElementById('deviceResetContainer');
                    const deviceValue = document.getElementById('deviceIdValue');
                    if (sub.deviceId) {
                        resetContainer.classList.remove('hidden');
                        deviceValue.textContent = sub.deviceId;
                    } else {
                        resetContainer.classList.add('hidden');
                    }

                    // Payment Information UI
                    const paymentInfoContainer = document.getElementById('paymentInfoContainer');
                    const paymentMethodValue = document.getElementById('paymentMethodValue');
                    const paymentProofImage = document.getElementById('paymentProofImage');

                    if (sub.paymentMethod || sub.paymentProofId) {
                        paymentInfoContainer.classList.remove('hidden');

                        // Display payment method
                        paymentMethodValue.textContent = sub.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                        // Display payment proof image
                        if (sub.paymentProofId) {
                            try {
                                const imageUrl = storage.getFileView(BUCKETS.COURSE_THUMBNAILS, sub.paymentProofId);
                                paymentProofImage.src = imageUrl;
                                document.getElementById('currentPaymentProofId').value = sub.paymentProofId;
                                document.getElementById('paymentProofContainer').classList.remove('hidden');
                            } catch (imgErr) {
                                console.error('Error loading payment proof:', imgErr);
                                document.getElementById('paymentProofContainer').classList.add('hidden');
                            }
                        } else {
                            document.getElementById('paymentProofContainer').classList.add('hidden');
                        }
                    } else {
                        paymentInfoContainer.classList.add('hidden');
                    }

                    document.getElementById('subscriberModal').classList.remove('hidden');

                    // Load courses and mark subscribed ones
                    await loadAdminSubCourses(sub.courses || []);
                } catch (e) { alert(e.message); }
            }

            async function deleteSubscriberPaymentProof() {
                const subId = document.getElementById('subId').value;
                const proofId = document.getElementById('currentPaymentProofId').value;

                if (!subId || !proofId) return;

                const result = await Swal.fire({
                    title: 'Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„',
                    text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                });

                if (result.isConfirmed) {
                    try {
                        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                        // 1. Delete file from storage
                        await storage.deleteFile(BUCKETS.COURSE_THUMBNAILS, proofId);

                        // 2. Update subscriber document
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, subId, {
                            paymentProofId: null
                        });

                        // 3. UI Updates
                        document.getElementById('paymentProofContainer').classList.add('hidden');
                        document.getElementById('currentPaymentProofId').value = '';

                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù',
                            text: 'ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
                            timer: 1500,
                            showConfirmButton: false
                        });

                    } catch (e) {
                        Swal.close();
                        alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + e.message);
                    }
                }
            }

            async function loadAdminSubCourses(subscribedIds = []) {
                const container = document.getElementById('adminSubCoursesList');
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSES);
                    container.innerHTML = response.documents.map(c => `
                        <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg cursor-pointer transition-colors border border-transparent">
                            <input type="checkbox" name="adminSubCourses" value="${c.$id}" class="accent-primary size-4" ${subscribedIds.includes(c.$id) ? 'checked' : ''}>
                            <span class="text-xs font-bold text-gray-400 dark:text-gray-300">${c.title}</span>
                        </label>
                    `).join('');
                } catch (e) { container.innerHTML = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„'; }
            }

            async function resetSubscriberDevice() {
                const id = document.getElementById('subId').value;
                if (!id) return;

                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙÙƒ Ø§Ø±ØªØ¨Ø§Ø· Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ Ø³ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯.')) return;

                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, id, {
                        deviceId: ''
                    });
                    alert('ØªÙ… ÙÙƒ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
                    document.getElementById('deviceResetContainer').classList.add('hidden');
                } catch (e) { alert(e.message); }
            }

            function viewPaymentProofFullscreen(imageUrl) {
                Swal.fire({
                    imageUrl: imageUrl,
                    imageAlt: 'ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„',
                    showCloseButton: true,
                    showConfirmButton: false,
                    width: '90%',
                    customClass: {
                        image: 'rounded-lg'
                    }
                });
            }

            function openSubscriberModal() {
                document.getElementById('subscriberForm').reset();
                document.getElementById('subId').value = '';
                document.getElementById('deviceResetContainer').classList.add('hidden');
                document.getElementById('paymentInfoContainer').classList.add('hidden');
                document.getElementById('subModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯';
                document.getElementById('subscriberModal').classList.remove('hidden');
                loadAdminSubCourses([]); // Reset courses
            }

            function closeSubscriberModal() {
                document.getElementById('subscriberModal').classList.add('hidden');
            }

            document.getElementById('subscriberForm').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('subId').value;
                const name = document.getElementById('subName').value;
                const phone = document.getElementById('subPhone').value;
                const password = document.getElementById('subPassword').value;
                const paymentStatus = document.getElementById('subPaymentStatus').value;

                const selectedCourses = Array.from(document.querySelectorAll('input[name="adminSubCourses"]:checked')).map(el => el.value);

                try {
                    const data = {
                        name: name,
                        phone: phone,
                        password: password,
                        paymentStatus: paymentStatus,
                        courses: selectedCourses
                    };

                    if (id) {
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, id, data);
                        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                    } else {
                        data.deviceId = '';
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, ID.unique(), data);
                        alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                    }

                    closeSubscriberModal();
                    fetchSubscribers();
                } catch (e) {
                    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + e.message);
                }
            };

            async function deleteSubscriber(id) {
                const result = await Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ',
                    text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                });

                if (result.isConfirmed) {
                    try {
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, id);
                        fetchSubscribers();
                    } catch (e) { alert(e.message); }
                }
            }

            async function fetchAdminNotifications() {
                const list = document.getElementById('notifications-list');
                const badge = document.getElementById('notif-badge');
                if (!list) return;

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.NOTIFICATIONS, [
                        Query.orderDesc('$createdAt'),
                        Query.limit(50)
                    ]);

                    if (response.documents.length > 0) {
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }

                    if (response.documents.length === 0) {
                        list.innerHTML = '<div class="text-center py-10 opacity-30 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ù…Ù†ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                        return;
                    }

                    list.innerHTML = response.documents.map(notif => `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl border border-red-100 dark:border-red-900/30 flex items-start gap-4 shadow-sm animate-pulse-subtle">
                            <div class="size-12 bg-red-100 dark:bg-red-900/30 rounded-2xl flex items-center justify-center text-red-500">
                                <span class="material-symbols-outlined">warning</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <h4 class="font-black text-secondary dark:text-white">${notif.action}</h4>
                                    <span class="text-[10px] text-gray-400 font-bold">${new Date(notif.$createdAt).toLocaleString('ar-EG')}</span>
                                </div>
                                <p class="text-xs font-bold text-gray-500">Ø§Ù„Ù…Ø´ØªØ±Ùƒ: <span class="text-secondary dark:text-white">${notif.subscriberName}</span></p>
                                <p class="text-[10px] text-gray-400 mt-2 italic">${notif.details || ''}</p>
                            </div>
                            <button onclick="deleteNotification('${notif.$id}')" class="text-gray-300 hover:text-red-500">
                                <span class="material-symbols-outlined text-sm">close</span>
                            </button>
                        </div>
                    `).join('');
                } catch (e) {
                    list.innerHTML = `<div class="text-center py-10 text-red-500">${e.message}</div>`;
                }
            }

            async function deleteNotification(id) {
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.NOTIFICATIONS, id);
                    fetchAdminNotifications();
                } catch (e) { }
            }

            // Auto refresh notifications every minute
            setInterval(fetchAdminNotifications, 60000);
            fetchAdminNotifications(); // Initial fetch

            function exportSubscribersToExcel() {
                if (allSubscribers.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
                        text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØµØ¯ÙŠØ±',
                        confirmButtonColor: '#13b6ec'
                    });
                    return;
                }

                // Prepare Data
                const data = allSubscribers.map(sub => {
                    const statusText = {
                        'pending': 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹',
                        'paid': 'ØªÙ… Ø§Ù„Ø¯ÙØ¹',
                        'blocked': 'Ù…Ø­Ø¸ÙˆØ±',
                        'unpaid': 'Ù„Ù… ÙŠØ¯ÙØ¹'
                    };

                    const subCourses = sub.courses || [];
                    const coursesSummary = subCourses.length > 0 ?
                        subCourses.map(id => courseMap[id] || 'ÙƒÙˆØ±Ø³ Ù…Ø­Ø°ÙˆÙ').join(', ') :
                        'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

                    return {
                        'Ø§Ù„Ø§Ø³Ù…': sub.name,
                        'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': sub.phone,
                        'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': sub.password || '', // Added Password field
                        'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹': statusText[sub.paymentStatus] || sub.paymentStatus,
                        'Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª': subCourses.length,
                        'Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª': coursesSummary,
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ': new Date(sub.$createdAt).toLocaleDateString('ar-EG'),
                        'Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø³Ø¬Ù„': sub.deviceId || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'
                    };
                });

                // Create Sheet
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†');

                // Download
                const fileName = `subscribers_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                Swal.fire({
                    icon: 'success',
                    title: 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­',
                    text: `ØªÙ… ØªØµØ¯ÙŠØ± ${allSubscribers.length} Ù…Ø´ØªØ±Ùƒ`,
                    confirmButtonColor: '#13b6ec'
                });
            }

            async function importSubscribersFromExcel(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {
                            type: 'array'
                        });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet);

                        if (rows.length === 0) {
                            alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª');
                            return;
                        }

                        // 1. Fetch Courses for Mapping (Title -> ID)
                        let courseTitleToId = {};
                        try {
                            const cRes = await databases.listDocuments(DATABASE_ID, COLLECTIONS.COURSES);
                            cRes.documents.forEach(c => {
                                courseTitleToId[c.title.trim()] = c.$id;
                            });
                        } catch (err) { console.error("Failed to load courses for mapping", err); }

                        let successCount = 0;
                        let failCount = 0;

                        Swal.fire({
                            title: 'Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...',
                            html: `<div class="text-lg font-bold">ØªÙ…: <span id="subImportProgress">0</span> / ${rows.length}</div>`,
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            didOpen: () => Swal.showLoading()
                        });

                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];
                            const name = row['Ø§Ù„Ø§Ø³Ù…'] || row['name'];
                            const phone = row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['phone'];
                            const password = row['ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'] || row['password'] || '123';

                            if (!name || !phone) {
                                failCount++;
                                continue;
                            }

                            // 2. Parse Payment Status
                            let pStatusRaw = row['Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹'] || row['paymentStatus'] || 'pending';
                            let pStatus = 'pending';
                            if (typeof pStatusRaw === 'string') {
                                pStatusRaw = pStatusRaw.toLowerCase();
                                if (pStatusRaw.includes('ØªÙ…') || pStatusRaw === 'paid') pStatus = 'paid';
                                else if (pStatusRaw.includes('Ù…Ø­Ø¸ÙˆØ±') || pStatusRaw === 'blocked') pStatus = 'blocked';
                                else if (pStatusRaw.includes('Ù„Ù…') || pStatusRaw === 'unpaid') pStatus = 'unpaid';
                            }

                            // 3. Parse and Map Courses
                            let coursesRaw = row['Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª'] || row['courses'] || '';
                            let courseIds = [];
                            if (coursesRaw) {
                                // Split by comma or Arabic comma
                                const names = coursesRaw.toString().split(/,|ØŒ/);
                                names.forEach(n => {
                                    const cleanName = n.trim();
                                    if (courseTitleToId[cleanName]) {
                                        courseIds.push(courseTitleToId[cleanName]);
                                    }
                                });
                            }

                            try {
                                const exist = await databases.listDocuments(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, [
                                    Query.equal('phone', String(phone))
                                ]);
                                if (exist.documents.length > 0) {
                                    console.log(`Skipping duplicate: ${name} (${phone})`);
                                    continue;
                                }

                                await databases.createDocument(DATABASE_ID, COLLECTIONS.SUBSCRIBERS, ID.unique(), {
                                    name: String(name),
                                    phone: String(phone),
                                    paymentStatus: pStatus,
                                    password: String(password),
                                    courses: courseIds
                                });
                                successCount++;
                            } catch (err) {
                                console.error('Import error', err);
                                failCount++;
                            }

                            document.getElementById('subImportProgress').textContent = i + 1;
                        }

                        await fetchSubscribers();

                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                            html: `
                                <div class="text-right" dir="rtl">
                                    <p class="text-green-600 font-bold">âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${successCount}</p>
                                    <p class="text-gray-500 font-bold">â­ï¸ ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ (Ù…ÙƒØ±Ø±/ÙØ§Ø±Øº): ${rows.length - successCount}</p>
                                </div>
                            `,
                            confirmButtonColor: '#13b6ec'
                        });

                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£',
                            text: e.message
                        });
                    }
                    event.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            }
        </script>
</body>

</html>